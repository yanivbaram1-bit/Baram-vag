<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAG Service | אזור אישי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { 
            font-family: 'Assistant', sans-serif; background: #f1f5f9; color: #1e293b; margin: 0;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
        }
        canvas { border: 2px dashed #cbd5e1; background: #ffffff; border-radius: 1.5rem; touch-action: none; width: 100%; }
        .card { background: white; border-radius: 2rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
        .status-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        img { -webkit-user-drag: none; user-drag: none; }
    </style>
</head>
<body class="p-4 pb-12">

    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600"></div>
    </div>

    <div id="errorMessage" class="hidden max-w-md mx-auto mt-20 text-center p-8 bg-white rounded-3xl shadow-xl">
        <i class="fas fa-exclamation-triangle text-4xl text-amber-500 mb-4"></i>
        <h2 class="text-xl font-black">רכב לא נמצא</h2>
        <p class="text-slate-500 mt-2">אנא וודא שהשתמשת בקישור המלא שנשלח אליך מהמוסך.</p>
    </div>

    <div id="appContent" class="hidden max-w-md mx-auto space-y-6">
        
        <div class="flex items-center justify-between px-2">
            <div>
                <h1 id="clientName" class="text-2xl font-black text-slate-900 italic">טוען...</h1>
                <p id="carPlateDisplay" class="text-blue-600 font-bold tracking-widest"></p>
            </div>
            <div class="bg-slate-900 text-white p-4 rounded-2xl shadow-lg"><i class="fas fa-car-side"></i></div>
        </div>

        <div class="card p-6 border-r-8 border-blue-600">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-2 h-2 bg-blue-600 rounded-full status-pulse"></div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">מצב נוכחי במוסך</span>
            </div>
            <p id="currentStatus" class="text-2xl font-black text-slate-800 italic">מעדכן...</p>
        </div>

        <div id="quoteArea" class="hidden card p-6 bg-slate-900 text-white border-none shadow-2xl shadow-blue-900/20">
            <h3 class="text-xl font-black mb-4 flex items-center gap-2 italic"><i class="fas fa-file-signature text-blue-400"></i> אישור עבודה נדרש</h3>
            <div id="itemsList" class="space-y-3 mb-6 text-sm opacity-90 border-b border-white/10 pb-4"></div>
            
            <div class="bg-white/5 p-4 rounded-2xl space-y-1 mb-6">
                <div class="flex justify-between text-xs opacity-60"><span>לפני מע"מ:</span><span id="priceBefore">₪0</span></div>
                <div class="flex justify-between text-xs text-blue-300"><span>מע"מ (18%):</span><span id="vatAmount">₪0</span></div>
                <div class="flex justify-between text-xl font-black pt-2 mt-2 border-t border-white/10"><span>סה"כ לתשלום:</span><span id="priceAfter">₪0</span></div>
            </div>

            <div id="sigContainer">
                <p class="text-[10px] text-blue-300 font-bold mb-2 mr-1">נא לחתום כאן לאישור:</p>
                <canvas id="sigCanvas" height="180"></canvas>
                <div class="flex gap-2 mt-4">
                    <button onclick="clearSig()" class="flex-1 bg-white/10 text-white p-4 rounded-2xl font-bold">נקה</button>
                    <button onclick="submitSig()" class="flex-[2] bg-blue-600 text-white p-4 rounded-2xl font-black shadow-lg">אשר ושלח</button>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="font-black text-lg mb-4 italic flex items-center gap-2 text-slate-800"><i class="fas fa-history text-blue-600 text-sm"></i> היסטוריית טיפולים</h3>
            <div id="historyList" class="space-y-4"></div>
        </div>
    </div>

    <script>
        // הגנות
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false; };

        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // חילוץ מספר רכב מהכתובת
        const urlParams = new URLSearchParams(window.location.search);
        const plate = urlParams.get('p');

        if (!plate) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
        } else {
            // טעינת נתונים בזמן אמת
            db.collection("customers").doc(plate).onSnapshot(doc => {
                document.getElementById('loader').classList.add('hidden');
                if (!doc.exists) {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    return;
                }

                document.getElementById('appContent').classList.remove('hidden');
                const data = doc.data();
                document.getElementById('clientName').innerText = `שלום, ${data.fName}`;
                document.getElementById('carPlateDisplay').innerText = plate;
                document.getElementById('currentStatus').innerText = data.status || "רשום במערכת";

                const quotes = data.quotes || [];
                const lastQuote = quotes[quotes.length - 1];

                // ניהול תצוגת הצעה
                if (lastQuote && !lastQuote.signed) {
                    document.getElementById('quoteArea').classList.remove('hidden');
                    const parts = lastQuote.description.split(' | ');
                    document.getElementById('itemsList').innerHTML = parts.filter(p => p.trim()).map(p => `<div class="font-bold"><i class="fas fa-check text-blue-400 ml-2"></i>${p.trim()}</div>`).join('');
                    
                    const total = parseFloat(lastQuote.total);
                    const sub = total / 1.18;
                    document.getElementById('priceBefore').innerText = "₪" + sub.toLocaleString(undefined,{maximumFractionDigits:0});
                    document.getElementById('vatAmount').innerText = "₪" + (total - sub).toLocaleString(undefined,{maximumFractionDigits:0});
                    document.getElementById('priceAfter').innerText = "₪" + total.toLocaleString();
                } else {
                    document.getElementById('quoteArea').classList.add('hidden');
                }

                // ניהול היסטוריה
                const signed = quotes.filter(q => q.signed).reverse();
                const hList = document.getElementById('historyList');
                if (signed.length > 0) {
                    hList.innerHTML = signed.map(q => `
                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div class="flex justify-between text-[9px] font-black text-slate-400 mb-2 uppercase">
                                <span>${q.signedAt || q.createdAt}</span>
                                <span class="text-green-600">בוצע מאושר</span>
                            </div>
                            <p class="text-xs font-bold text-slate-700 mb-2">${q.description.replace(/\|/g, '<br>')}</p>
                            <p class="text-sm font-black border-t pt-2 mt-2 italic">סה"כ: ₪${parseFloat(q.total).toLocaleString()}</p>
                        </div>
                    `).join('');
                } else {
                    hList.innerHTML = "<p class='text-xs text-slate-400 italic text-center'>טרם בוצעו טיפולים רשומים.</p>";
                }
            }, err => {
                console.error(err);
                document.getElementById('errorMessage').classList.remove('hidden');
            });
        }

        // לוגיקת חתימה
        const canvas = document.getElementById('sigCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('touchstart', (e) => { drawing = true; e.preventDefault(); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', (e) => { draw(e); e.preventDefault(); });
        window.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        window.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });

        function draw(e) {
            if (!drawing) return;
            const pos = getPos(e);
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#0f172a';
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
        }
        function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        async function submitSig() {
            const sigData = canvas.toDataURL();
            if (sigData.length < 2000) return alert("אנא חתום בתיבה");
            const docRef = db.collection("customers").doc(plate);
            const doc = await docRef.get();
            let quotes = doc.data().quotes;
            quotes[quotes.length-1].signed = true;
            quotes[quotes.length-1].signature = sigData;
            quotes[quotes.length-1].signedAt = new Date().toLocaleString('he-IL');
            await docRef.update({ quotes: quotes, status: "אושר - בתחילת עבודה" });
            alert("האישור נשלח בהצלחה!");
        }

        function resize() { canvas.width = canvas.offsetWidth; }
        window.addEventListener('resize', resize); resize();
    </script>
</body>
</html>
