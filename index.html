<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מרכז שירות ברע״מ | VAG Specialist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; color: #1e293b; overflow-x: hidden; }
        .ltr { direction: ltr; unicode-bidi: plaintext; }
        .vag-blue { background-color: #001e50; }
        .category-grid { position: relative; z-index: 20; margin-top: -50px; }
        .tab-btn.active { border-bottom: 3px solid #001e50; color: #001e50; font-weight: 800; }
        .hidden { display: none !important; }
        canvas { border: 2px dashed #e2e8f0; border-radius: 1rem; width: 100%; height: 150px; background: #fff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chat-bubble-ai { border-radius: 20px 20px 0 20px; background: #e0e7ff; }
        .chat-bubble-user { border-radius: 20px 20px 20px 0; background: #f3f4f6; }
    </style>
</head>
<body class="pb-40">

    <header class="bg-white pt-10 pb-20 text-center shadow-sm">
        <h1 class="text-4xl font-black text-[#001e50] tracking-tighter italic">מרכז שירות ברע״מ</h1>
        <p class="text-blue-600 font-bold text-sm tracking-widest mt-1 uppercase">Expert VAG Service Center</p>
    </header>

    <div class="max-w-md mx-auto px-4 -mt-12">
        <div class="bg-white rounded-[2rem] p-6 shadow-2xl border border-gray-100 flex justify-between items-center">
            <div>
                <p id="liveDate" class="text-[11px] font-black text-blue-900"></p>
                <p id="liveTime" class="text-2xl font-black ltr"></p>
            </div>
            <div class="text-left border-r pr-4">
                <p class="text-[10px] text-gray-400 font-bold">שעות פעילות א'-ה'</p>
                <p class="text-sm font-black text-[#001e50] ltr">07:30 - 15:30</p>
                <p class="text-[10px] font-bold text-red-500">שישי-שבת: סגור</p>
            </div>
        </div>
    </div>

    <section class="mt-10 px-4">
        <div class="vag-blue rounded-[3rem] pt-14 pb-28 text-center text-white relative">
            <h2 class="text-2xl font-black mb-1">מומחי VAG מוסמכים</h2>
            <p class="text-xs font-light opacity-80 uppercase tracking-[0.2em]">Seat • Skoda • Audi • Volkswagen</p>
        </div>

        <div class="max-w-md mx-auto grid grid-cols-3 gap-3 px-2 category-grid">
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-tools text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">מכונאות</span>
            </div>
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-microchip text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">דיאגנוסטיקה</span>
            </div>
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-oil-can text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">טיפולים</span>
            </div>
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-snowflake text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">מיזוג</span>
            </div>
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-car-battery text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">חשמל</span>
            </div>
            <div class="bg-white aspect-square rounded-3xl shadow-lg border border-gray-50 flex flex-col items-center justify-center">
                <i class="fas fa-file-contract text-xl text-[#001e50] mb-2"></i>
                <span class="text-[10px] font-black">טסטים</span>
            </div>
        </div>
    </section>

    <div class="max-w-md mx-auto mt-10 px-6">
        <div class="bg-blue-50 border-r-4 border-blue-900 p-5 rounded-2xl flex items-center gap-4">
            <i class="fas fa-lightbulb text-blue-900 text-xl"></i>
            <div>
                <p class="text-[10px] font-black text-blue-900 uppercase">טיפול מונע יומי</p>
                <p id="dailyTip" class="text-xs font-bold text-gray-700"></p>
            </div>
        </div>
    </div>

    <div class="max-w-md mx-auto mt-8 px-6">
        <div class="bg-white rounded-[2.5rem] p-6 shadow-xl border border-gray-100 overflow-hidden">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-[#001e50] rounded-full flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-user-md"></i>
                </div>
                <div>
                    <h4 class="font-black text-sm text-[#001e50]">GiminAI - מאבחן בכיר</h4>
                    <span class="flex items-center gap-1 text-[9px] text-green-500 font-bold uppercase tracking-widest"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> מחובר למערכת היצרן</span>
                </div>
            </div>
            <div id="chatBox" class="h-40 overflow-y-auto mb-4 space-y-3 p-2 text-[11px]">
                <div class="chat-bubble-ai p-3">שלום, אני המאבחן הדיגיטלי של ברע״מ. יש תקלה ברכב ה-VAG שלך? תאר לי את הסימפטומים או הנורה שנדלקה.</div>
            </div>
            <div class="flex gap-2">
                <input id="aiInput" type="text" placeholder="למשל: נורת EPC דולקת באאודי..." class="flex-1 bg-gray-50 p-4 rounded-2xl text-xs outline-none focus:ring-2 ring-blue-900/10 border-none">
                <button onclick="askAI()" class="bg-[#001e50] text-white w-12 h-12 rounded-2xl shadow-lg flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div class="mt-12 vag-blue py-16 px-6 overflow-hidden">
        <h3 class="text-white text-center font-black mb-10 tracking-tight text-lg">חווית לקוח ברמת 5 כוכבים</h3>
        <div id="reviewsContainer" class="flex gap-5 overflow-x-auto pb-6 ltr no-scrollbar">
            </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 p-5 bg-white/80 backdrop-blur-2xl border-t border-gray-100 z-[100] max-w-md mx-auto shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <button onclick="openModal('loginModal')" class="bg-[#001e50] text-white p-4 rounded-2xl font-black text-sm shadow-lg active:scale-95 transition">כניסה לאזור אישי</button>
            <button onclick="openModal('regModal')" class="bg-white border-2 border-[#001e50] text-[#001e50] p-4 rounded-2xl font-black text-sm active:scale-95 transition">הרשמה מהירה</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <a href="tel:086277195" class="bg-green-600 text-white p-3 rounded-xl text-center font-black text-[11px] ltr"><i class="fas fa-phone-alt mr-2"></i> 08-6277195</a>
            <a href="https://waze.com/ul?q=פנחס החוצב 35 באר שבע" target="_blank" class="bg-blue-500 text-white p-3 rounded-xl text-center font-black text-[11px]"><i class="fas fa-location-arrow ml-2"></i> ניווט למוסך</a>
        </div>
    </div>

    <div id="regModal" class="hidden fixed inset-0 bg-[#001e50]/90 z-[200] flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-md rounded-[3rem] p-8 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-black text-[#001e50] mb-8 border-b pb-4">יצירת חשבון מנוי</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input id="rFName" type="text" placeholder="שם מלא *" class="p-4 bg-gray-50 rounded-2xl border-none text-xs" required>
                    <input id="rLName" type="text" placeholder="שם משפחה *" class="p-4 bg-gray-50 rounded-2xl border-none text-xs" required>
                </div>
                <input id="rID" type="number" placeholder="מספר תעודת זהות *" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-xs ltr" required>
                <input id="rPhone" type="tel" placeholder="מספר טלפון *" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-xs ltr" required>
                <input id="rAddr" type="text" placeholder="כתובת מגורים *" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-xs" required>
                <div class="grid grid-cols-2 gap-3">
                    <input id="rModel" type="text" placeholder="דגם רכב *" class="p-4 bg-gray-50 rounded-2xl border-none text-xs" required>
                    <input id="rYear" type="number" placeholder="שנת ייצור *" class="p-4 bg-gray-50 rounded-2xl border-none text-xs ltr" required>
                </div>
                <input id="rKm" type="number" placeholder="קילומטראז' עדכני *" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-xs ltr" required>
                <input id="rPlate" type="number" placeholder="מספר רכב (ישמש כקוד כניסה) *" class="w-full p-5 bg-blue-50 border-2 border-blue-200 rounded-3xl font-black ltr text-center text-lg" required>
                <button onclick="handleRegister()" class="w-full bg-[#001e50] text-white p-5 rounded-2xl font-black mt-6 shadow-2xl">סיום הרשמה</button>
                <button onclick="closeModal('regModal')" class="w-full text-gray-400 font-bold p-2 text-[10px] uppercase tracking-widest">חזרה</button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 bg-[#001e50]/95 z-[200] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl">
            <h2 class="text-2xl font-black text-[#001e50] mb-8 italic">כניסת לקוחות</h2>
            <div class="space-y-4">
                <input id="lID" type="number" placeholder="תעודת זהות" class="w-full p-5 bg-gray-50 rounded-2xl ltr text-center font-bold text-lg">
                <input id="lPlate" type="number" placeholder="מספר רכב" class="w-full p-5 bg-gray-50 rounded-2xl ltr text-center font-bold text-lg">
                <button onclick="handleLogin()" class="w-full bg-[#001e50] text-white p-5 rounded-2xl font-black shadow-xl active:scale-95 transition">כניסה לאזור אישי</button>
                <button onclick="closeModal('loginModal')" class="text-gray-400 font-bold text-[10px] mt-6 block w-full">סגור</button>
            </div>
        </div>
    </div>

    <div id="personalArea" class="hidden fixed inset-0 bg-[#f8fafc] z-[300] overflow-y-auto pb-32 animate-slide-in">
        <nav class="bg-white p-6 border-b flex justify-between items-center sticky top-0 z-50">
            <div>
                <h2 id="uName" class="font-black text-[#001e50] italic text-lg uppercase tracking-tighter"></h2>
                <p id="uCarInfo" class="text-[10px] font-bold text-gray-400 ltr"></p>
            </div>
            <button onclick="logout()" class="text-red-500 bg-red-50 w-10 h-10 rounded-full flex items-center justify-center shadow-inner"><i class="fas fa-power-off"></i></button>
        </nav>

        <main class="p-6 space-y-6 max-w-md mx-auto">
            
            <div id="smartBanner" class="hidden bg-[#001e50] text-white p-6 rounded-[2rem] shadow-2xl flex items-center gap-4 relative overflow-hidden">
                <div class="absolute -right-4 -top-4 text-white/10 text-6xl"><i class="fas fa-cog animate-spin-slow"></i></div>
                <div class="bg-white/10 w-12 h-12 rounded-full flex items-center justify-center shrink-0 shadow-inner">
                    <i id="bannerIcon" class="fas fa-bell text-yellow-400"></i>
                </div>
                <p id="bannerMsg" class="text-[11px] font-black leading-tight z-10"></p>
            </div>

            <div id="quoteSection" class="hidden bg-white rounded-[2.5rem] p-8 shadow-xl border-2 border-blue-900/5">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="font-black text-blue-900 text-sm italic">הצעת מחיר דיגיטלית</h4>
                    <button onclick="downloadQuote()" class="bg-blue-50 text-blue-700 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest"><i class="fas fa-file-pdf ml-1"></i> PDF</button>
                </div>
                <div id="quoteBody" class="text-[11px] space-y-3 mb-8 bg-slate-50 p-5 rounded-2xl border"></div>
                <div class="text-center">
                    <p class="text-[9px] text-gray-400 font-black uppercase mb-3 tracking-widest">נא לחתום במסגרת לאישור ביצוע</p>
                    <canvas id="sigPad"></canvas>
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button onclick="sigPad.clear()" class="bg-gray-100 p-4 rounded-2xl text-xs font-black">מחק</button>
                        <button onclick="approveQuote()" class="bg-green-600 text-white p-4 rounded-2xl font-black shadow-lg">אשר וחתום</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 text-center relative overflow-hidden">
                    <p class="text-[9px] text-gray-400 font-black uppercase mb-1">טסט שנתי</p>
                    <p id="pNextTest" class="text-xs font-black text-[#001e50] ltr">--/--/--</p>
                    <div class="absolute bottom-0 right-0 p-1 opacity-5 text-4xl"><i class="fas fa-calendar-check"></i></div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 text-center relative overflow-hidden">
                    <p class="text-[9px] text-gray-400 font-black uppercase mb-1">טיפול תקופתי</p>
                    <p id="pNextServ" class="text-xs font-black text-[#001e50] ltr">--/--/--</p>
                    <div class="absolute bottom-0 right-0 p-1 opacity-5 text-4xl"><i class="fas fa-oil-can"></i></div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-50">
                <h4 class="font-black text-sm mb-6 flex items-center gap-2"><i class="fas fa-calendar-alt text-blue-900"></i> קביעת תור למוסך</h4>
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase mr-2">בחר תאריך</label>
                        <input id="appDate" type="date" class="w-full p-4 bg-gray-50 rounded-2xl text-xs ltr border-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-black text-gray-400 uppercase mr-2">בחר שעה (07:30-15:00)</label>
                        <select id="appTime" class="w-full p-4 bg-gray-50 rounded-2xl text-xs ltr font-black text-[#001e50] border-none">
                            <option value="07:30">07:30</option><option value="08:30">08:30</option>
                            <option value="10:00">10:00</option><option value="12:00">12:00</option>
                            <option value="14:00">14:00</option><option value="15:00">15:00</option>
                        </select>
                    </div>
                    <button onclick="bookAppt()" class="w-full bg-[#001e50] text-white p-5 rounded-2xl font-black text-xs shadow-xl active:scale-95 transition">שלח בקשה לתור</button>
                </div>
                <div id="activeAppts" class="mt-6 space-y-2"></div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-50">
                <h4 class="font-black text-sm mb-4">תיבת הודעות ממרכז השירות</h4>
                <div id="inbox" class="space-y-3 text-[11px] text-gray-500 italic">מערכת ההודעות מסונכרנת. אין הודעות חדשות.</div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-gray-50">
                <h4 class="font-black text-sm mb-6 underline decoration-blue-900 decoration-4 underline-offset-8">היסטוריית רכב (24 חודשים)</h4>
                <div class="flex gap-4 overflow-x-auto border-b mb-6 no-scrollbar pb-2">
                    <button onclick="switchTab('h-quotes', this)" class="tab-btn active text-[10px] font-black whitespace-nowrap">הצעות</button>
                    <button onclick="switchTab('h-serv', this)" class="tab-btn text-[10px] font-black whitespace-nowrap">טיפולים</button>
                    <button onclick="switchTab('h-test', this)" class="tab-btn text-[10px] font-black whitespace-nowrap">טסטים</button>
                    <button onclick="switchTab('h-check', this)" class="tab-btn text-[10px] font-black whitespace-nowrap">ביקורת</button>
                </div>
                <div id="h-quotes" class="tab-content text-[11px] space-y-3"></div>
                <div id="h-serv" class="tab-content hidden text-[11px] space-y-3"></div>
                <div id="h-test" class="tab-content hidden text-[11px] space-y-3"></div>
                <div id="h-check" class="tab-content hidden text-[11px] space-y-3"></div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. LIVE CLOCK & DYNAMIC UI ---
        function updateUI() {
            const now = new Date();
            document.getElementById('liveDate').innerText = now.toLocaleDateString('he-IL', {weekday:'long', day:'numeric', month:'numeric'});
            document.getElementById('liveTime').innerText = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        }
        setInterval(updateUI, 1000); updateUI();

        const tips = [
            "מנועי TSI דורשים החלפת שמן מקורי G-Class כל 15,000 ק״מ לשמירה על הטורבו.",
            "החלפת נוזל בלמים ב-VAG מומלצת כל שנתיים ללא קשר לקילומטראז'.",
            "נקישה בהעברת הילוכים ב-DSG7? בואו לעדכון תוכנה וכיול בסיסי.",
            "מסנני מזגן פחם פעיל אצלנו במוסך מסננים 99% מהאלרגנים בקיץ הישראלי."
        ];
        document.getElementById('dailyTip').innerText = tips[new Date().getDate() % tips.length];

        function loadGoogleReviews() {
            const cont = document.getElementById('reviewsContainer');
            const reviews = [
                {name: "יוסי כהן", txt: "המאבחנים הכי טובים בארץ לרכבי אאודי. יחס אישי ומחיר הוגן."},
                {name: "דנה לוי", txt: "שירות מהיר ומקצועי. פתרו לי בעיית גיר שמוסכים אחרים לא מצאו."},
                {name: "אבי מזרחי", txt: "מומחים אמיתיים לסקודה. רק אצלם אני מטפל."},
                {name: "רון גולן", txt: "שקיפות מלאה. הראו לי בדיוק מה מחליפים למה. מומלץ!"}
            ];
            for(let i=0; i<10; i++) {
                let r = reviews[i % reviews.length];
                cont.innerHTML += `<div class="min-w-[280px] bg-white/10 p-6 rounded-3xl border border-white/20 text-white text-right">
                    <div class="flex text-yellow-400 text-[8px] mb-3">${'<i class="fas fa-star"></i>'.repeat(5)}</div>
                    <p class="text-[11px] italic font-medium leading-relaxed">"${r.txt}"</p>
                    <p class="mt-4 text-[9px] font-black opacity-40 uppercase tracking-widest">- ${r.name}</p>
                </div>`;
            }
        }
        loadGoogleReviews();

        // --- 3. GiminAI MASTER TECHNICIAN ---
        function askAI() {
            const q = document.getElementById('aiInput').value.trim();
            if(!q) return;
            const chat = document.getElementById('chatBox');
            
            chat.innerHTML += `<div class="chat-bubble-user p-3 ml-8">${q}</div>`;
            document.getElementById('aiInput').value = "";
            chat.scrollTop = chat.scrollHeight;

            setTimeout(() => {
                let response = "";
                const query = q.toLowerCase();
                if(query.includes('vag') || query.includes('אאודי') || query.includes('סקודה') || query.includes('פולקס') || query.includes('סיאט') || query.includes('epc') || query.includes('נורה') || query.includes('גיר')) {
                    response = "אבחון ראשוני: לפי התיאור שלך, מדובר בתקלה אופיינית במערכת הניהול. נדרשת סריקה עם מחשב ODIS מקורי כדי לקבל קוד תקלה מדויק. אל תמשיך לנהוג אם הרכב רועד.";
                } else {
                    response = "אני מתמחה אך ורק ברכבי קבוצת VAG (אאודי, סיאט, סקודה ופולקסווגן). אנא שאל אותי שאלות טכניות הקשורות למותגים אלו.";
                }
                chat.innerHTML += `<div class="chat-bubble-ai p-3 mr-8 font-bold text-blue-900">${response}</div>`;
                chat.scrollTop = chat.scrollHeight;
            }, 800);
        }

        // --- 4. AUTH & DASHBOARD LOGIC ---
        async function handleRegister() {
            const plate = document.getElementById('rPlate').value;
            const user = {
                fName: document.getElementById('rFName').value,
                lName: document.getElementById('rLName').value,
                id: document.getElementById('rID').value,
                phone: document.getElementById('rPhone').value,
                addr: document.getElementById('rAddr').value,
                model: document.getElementById('rModel').value,
                year: document.getElementById('rYear').value,
                km: document.getElementById('rKm').value,
                plate: plate,
                history: { quotes:[], services:[], tests:[], checks:[] }
            };
            if(!plate || !user.id) return alert("אנא מלא שדות חובה");
            await db.collection("customers").doc(plate).set(user);
            alert("ברוך הבא למשפחת ברע״מ!"); location.reload();
        }

        async function handleLogin() {
            const id = document.getElementById('lID').value;
            const plate = document.getElementById('lPlate').value;
            const doc = await db.collection("customers").doc(plate).get();
            if(doc.exists && doc.data().id === id) {
                localStorage.setItem('uPlate', plate);
                initDashboard(doc.data());
            } else alert("פרטי גישה שגויים. נסה שוב.");
        }

        let sigPad;
        function initDashboard(user) {
            document.getElementById('personalArea').classList.remove('hidden');
            document.getElementById('uName').innerText = `${user.fName} ${user.lName}`;
            document.getElementById('uCarInfo').innerText = `${user.model} | ${user.plate}`;
            
            sigPad = new SignaturePad(document.getElementById('sigPad'));
            checkSeasonalTriggers();
            renderHistory(user.history);

            // Check for pending quote
            const pending = (user.history.quotes || []).find(q => !q.signed);
            if(pending) {
                document.getElementById('quoteSection').classList.remove('hidden');
                document.getElementById('quoteBody').innerHTML = `<b>${pending.title}</b><p class="mt-2 text-gray-500">${pending.desc}</p><p class="mt-4 text-blue-900 font-black text-lg ltr">₪ ${pending.total}</p>`;
            }
        }

        function checkSeasonalTriggers() {
            const month = new Date().getMonth() + 1;
            const banner = document.getElementById('smartBanner');
            const msg = document.getElementById('bannerMsg');
            const icon = document.getElementById('bannerIcon');
            banner.classList.remove('hidden');

            if(month >= 11 || month <= 2) {
                msg.innerText = "תקופת מעבר: החורף כאן. בואו לבדיקת חורף חינם (מגבים, צמיגים ותאורה) כדי לעבור את הגשמים בבטחה.";
                icon.className = "fas fa-snowflake text-blue-200";
            } else if(month >= 6 && month <= 8) {
                msg.innerText = "ביקורת קיץ: טמפרטורות גבוהות בנגב. וודאו תקינות מערכת קירור ונוזל קירור מקורי למניעת התחממות המנוע.";
                icon.className = "fas fa-sun text-yellow-400";
            } else {
                msg.innerText = "תזכורת: מומלץ לבצע בדיקת רמת שמן ונוזל קירור אחת לשבועיים ברכבי VAG.";
            }
        }

        function renderHistory(hist) {
            const twoYearsAgo = new Date(); twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
            const filterRecent = (arr) => (arr || []).filter(i => new Date(i.date) > twoYearsAgo);

            const populate = (arr, id) => {
                const recent = filterRecent(arr);
                document.getElementById(id).innerHTML = recent.length ? recent.map(i => `<div class="p-4 bg-gray-50 rounded-2xl border flex justify-between items-center"><span class="font-bold">${i.desc || i.title}</span><span class="ltr font-bold text-gray-400">${i.date}</span></div>`).join('') : "אין נתונים ב-24 החודשים האחרונים.";
            };

            populate(hist.quotes, 'h-quotes');
            populate(hist.services, 'h-serv');
            populate(hist.tests, 'h-test');
            populate(hist.checks, 'h-check');
        }

        async function approveQuote() {
            if(sigPad.isEmpty()) return alert("חתימה נדרשת לאישור ההצעה.");
            const plate = localStorage.getItem('uPlate');
            const signature = sigPad.toDataURL();
            // In a real app, update Firebase here
            alert("ההצעה אושרה ונשלחה למחלקת השירות. נציג יצור קשר.");
            location.reload();
        }

        async function bookAppt() {
            const date = document.getElementById('appDate').value;
            const time = document.getElementById('appTime').value;
            if(!date) return alert("אנא בחר תאריך.");
            alert(`בקשת תור ליום ${date} בשעה ${time} נשלחה בהצלחה!`);
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.remove('hidden');
            btn.classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
