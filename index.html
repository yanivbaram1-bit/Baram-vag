<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAG Service | אזור אישי לקוח</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        
        /* הגנות CSS - מניעת סימון והעתקה */
        body { 
            font-family: 'Assistant', sans-serif; 
            background: #f1f5f9; 
            color: #1e293b; 
            margin: 0;
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* מניעת סימון טקסט */
            -webkit-touch-callout: none; /* מניעת תפריט לחיצה ארוכה בנייד */
        }

        canvas { 
            border: 2px dashed #cbd5e1; 
            background: #ffffff; 
            border-radius: 1.5rem; 
            touch-action: none; 
        }

        .card { 
            background: white; 
            border-radius: 2rem; 
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); 
            border: 1px solid #e2e8f0; 
        }

        .status-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        img {
            -webkit-user-drag: none; /* מניעת גרירת תמונות */
            user-drag: none;
        }
    </style>
</head>
<body class="p-4 md:p-8 pb-12">

    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600"></div>
    </div>

    <div class="max-w-md mx-auto space-y-6">
        
        <div class="flex items-center justify-between mb-4 px-2">
            <div>
                <h1 id="clientName" class="text-2xl font-black text-slate-900">טוען...</h1>
                <p id="carPlate" class="text-blue-600 font-bold tracking-widest"></p>
            </div>
            <div class="bg-slate-900 text-white p-3 rounded-2xl shadow-lg">
                <i class="fas fa-car-side text-xl"></i>
            </div>
        </div>

        <div class="card p-6 border-r-8 border-blue-600">
            <div class="flex items-center gap-4">
                <div class="w-3 h-3 bg-blue-600 rounded-full status-pulse"></div>
                <h3 class="font-bold text-slate-400 text-xs uppercase tracking-widest">מצב הרכב במוסך</h3>
            </div>
            <p id="currentStatus" class="text-2xl font-black mt-2 text-slate-800 italic">מעדכן סטטוס...</p>
        </div>

        <div id="quoteArea" class="hidden space-y-4">
            <div class="card p-6 bg-slate-900 text-white border-none shadow-blue-900/20 shadow-2xl">
                <h3 class="text-xl font-black mb-4 flex items-center gap-2">
                    <i class="fas fa-file-signature text-blue-400"></i> אישור עבודה נדרש
                </h3>
                <div id="itemsList" class="space-y-3 mb-6 text-sm opacity-90"></div>
                
                <div class="bg-white/10 p-4 rounded-2xl space-y-1 mb-6">
                    <div class="flex justify-between text-xs opacity-70"><span>לפני מע"מ:</span><span id="priceBefore">₪0</span></div>
                    <div class="flex justify-between text-xs text-blue-300"><span>מע"מ (18%):</span><span id="vatAmount">₪0</span></div>
                    <div class="flex justify-between text-lg font-black pt-2 border-t border-white/10"><span>סה"כ לתשלום:</span><span id="priceAfter">₪0</span></div>
                </div>

                <div id="signatureSection">
                    <canvas id="sigCanvas" class="w-full h-40 mb-4"></canvas>
                    <div class="flex gap-2">
                        <button onclick="clearSig()" class="flex-1 bg-white/5 text-white p-4 rounded-2xl font-bold">נקה</button>
                        <button onclick="submitSig()" class="flex-[2] bg-blue-600 text-white p-4 rounded-2xl font-black">חתום ואשר עבודה</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-6">
            <h3 class="font-black text-lg mb-4 italic flex items-center gap-2 text-slate-800">
                <i class="fas fa-history text-blue-600 text-sm"></i> היסטוריית טיפולים קודמים
            </h3>
            <div id="historyList" class="space-y-4">
                <p class="text-xs text-slate-400 italic">אין עדיין טיפולים רשומים במערכת.</p>
            </div>
        </div>

        <p class="text-[10px] text-center text-slate-400 font-bold uppercase tracking-tighter mt-10">Baram VAG Performance & Service</p>
    </div>

    <script>
        /* --- הגנות אבטחה (Code Protection) --- */
        
        // חסימת מקש ימני
        document.addEventListener('contextmenu', event => event.preventDefault());

        // חסימת קיצורי מקלדת (F12, Inspect Element)
        document.onkeydown = function(e) {
            if(event.keyCode == 123) { return false; } // F12
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; } // Ctrl+Shift+I
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; } // Ctrl+Shift+J
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; } // Ctrl+U
        };

        /* --- חיבור ל-Firebase --- */

        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const plate = new URLSearchParams(window.location.search).get('p');
        if (!plate) { alert("מספר רכב לא נמצא בקישור"); }

        db.collection("customers").doc(plate).onSnapshot(doc => {
            document.getElementById('loader').classList.add('hidden');
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('clientName').innerText = `שלום, ${data.fName}`;
                document.getElementById('carPlate').innerText = plate;
                document.getElementById('currentStatus').innerText = data.status || "רשום במערכת";

                const quotes = data.quotes || [];
                const lastQuote = quotes[quotes.length - 1];
                const quoteArea = document.getElementById('quoteArea');

                // הצגת הצעה פתוחה
                if (lastQuote && !lastQuote.signed) {
                    quoteArea.classList.remove('hidden');
                    const descParts = lastQuote.description.split(' | ');
                    document.getElementById('itemsList').innerHTML = descParts.filter(p => p.trim()).map(p => 
                        `<div class="flex justify-between items-center"><span class="font-bold"><i class="fas fa-check text-blue-400 ml-2"></i>${p.trim()}</span></div>`
                    ).join('');
                    
                    const total = parseFloat(lastQuote.total);
                    const beforeVat = total / 1.18;
                    document.getElementById('priceBefore').innerText = "₪" + beforeVat.toLocaleString(undefined, {maximumFractionDigits:0});
                    document.getElementById('vatAmount').innerText = "₪" + (total - beforeVat).toLocaleString(undefined, {maximumFractionDigits:0});
                    document.getElementById('priceAfter').innerText = "₪" + total.toLocaleString();
                } else {
                    quoteArea.classList.add('hidden');
                }

                // היסטוריית טיפולים חתומים
                const historyList = document.getElementById('historyList');
                const signedQuotes = quotes.filter(q => q.signed).reverse();
                if (signedQuotes.length > 0) {
                    historyList.innerHTML = signedQuotes.map(q => `
                        <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-[9px] font-black text-slate-400 uppercase">${q.signedAt || q.createdAt}</span>
                                <span class="bg-green-100 text-green-700 text-[9px] px-2 py-0.5 rounded-full font-black">בוצע</span>
                            </div>
                            <p class="text-xs font-bold text-slate-700 mb-2">${q.description.replace(/\|/g, '<br>')}</p>
                            <p class="text-sm font-black border-t pt-2">סה"כ שולם: ₪${parseFloat(q.total).toLocaleString()}</p>
                        </div>
                    `).join('');
                }
            }
        });

        /* --- מנגנון חתימה --- */
        const canvas = document.getElementById('sigCanvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('touchstart', (e) => { drawing = true; e.preventDefault(); }, {passive: false});
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', (e) => { draw(e); e.preventDefault(); }, {passive: false});
        window.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        window.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });

        function draw(e) {
            if (!drawing) return;
            const pos = getPos(e);
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#1e293b';
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
        }

        function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        async function submitSig() {
            const sigData = canvas.toDataURL();
            if (sigData.length < 2000) return alert("אנא חתום בתיבה לאישור");
            
            const docRef = db.collection("customers").doc(plate);
            const doc = await docRef.get();
            let quotes = doc.data().quotes;
            
            // עדכון הצעה אחרונה
            quotes[quotes.length - 1].signed = true;
            quotes[quotes.length - 1].signature = sigData;
            quotes[quotes.length - 1].signedAt = new Date().toLocaleString('he-IL');
            
            await docRef.update({ 
                quotes: quotes, 
                status: "אושר - בתחילת עבודה" 
            });
            
            alert("האישור התקבל! אנחנו מתחילים לעבוד על הרכב.");
        }

        function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
