<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×‘×¨×¢×´× VAG | ××¤×œ×™×§×¦×™×™×ª ×œ×§×•×—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f4f7f9; }
        .vag-blue { background-color: #001e50; }
        #sigPad { width: 100%; height: 180px; background: white; border: 2px dashed #cbd5e1; border-radius: 1rem; }
    </style>
</head>
<body class="pb-10">
    <header class="vag-blue pt-12 pb-24 text-white text-center rounded-b-[3rem]">
        <h1 class="text-4xl font-black italic">BARAM <span class="text-blue-400">VAG</span></h1>
        <p class="opacity-70 mt-2">××¨×›×– ×©×™×¨×•×ª ××•××—×” - ×‘××¨ ×©×‘×¢</p>
    </header>

    <main class="max-w-md mx-auto px-6 -mt-12">
        <div id="authBox" class="bg-white p-8 rounded-[2rem] shadow-xl">
            <h2 class="text-xl font-black text-center mb-6">×›× ×™×¡×” ×œ××–×•×¨ ×”××™×©×™</h2>
            <input id="lPlate" placeholder="××¡×¤×¨ ×¨×›×‘" class="w-full p-4 bg-gray-50 border rounded-2xl text-center font-black mb-4 outline-none">
            <input id="lID" placeholder="×ª×¢×•×“×ª ×–×”×•×ª" class="w-full p-4 bg-gray-50 border rounded-2xl text-center mb-6 outline-none">
            <button onclick="handleLogin()" class="w-full vag-blue text-white p-5 rounded-2xl font-black">×”×ª×—×‘×¨</button>
        </div>

        <div id="dash" class="hidden space-y-6 mt-4">
            <div class="bg-white p-6 rounded-3xl shadow-sm border-r-8 border-blue-500 flex justify-between">
                <div><p class="text-xs text-gray-400 font-bold">×¡×˜×˜×•×¡ ×¨×›×‘</p><h3 id="statText" class="text-xl font-black text-blue-900">×˜×•×¢×Ÿ...</h3></div>
            </div>

            <div id="quoteBox" class="hidden bg-amber-50 p-6 rounded-3xl border-2 border-amber-200">
                <h3 class="font-black text-amber-900 mb-4 text-center">×”×¦×¢×ª ××—×™×¨ ×œ××™×©×•×¨</h3>
                <div class="bg-white rounded-xl shadow-inner mb-4 overflow-hidden">
                    <table class="w-full text-right text-xs">
                        <tbody id="qTable"></tbody>
                        <tfoot class="bg-gray-100 font-black"><tr><td class="p-3">×¡×”"×› (×›×•×œ×œ ××¢"×)</td><td id="qTotal" class="p-3 text-center"></td></tr></tfoot>
                    </table>
                </div>
                <canvas id="sigPad"></canvas>
                <button onclick="approve()" class="w-full bg-green-600 text-white p-5 rounded-2xl font-black mt-4 shadow-lg">××©×¨ ×•×—×ª×•×</button>
            </div>
            
            <a href="https://waze.com/ul?q=×¤× ×—×¡ ×”×—×•×¦×‘ 35 ×‘××¨ ×©×‘×¢" class="block w-full bg-white p-5 rounded-2xl text-center font-bold border-2 border-blue-100">× ×•×•×˜ ××œ ×”××•×¡×š ğŸ“</a>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let sPad, curPlate, curData;

        async function handleLogin() {
            const p = document.getElementById('lPlate').value.trim(), id = document.getElementById('lID').value.trim();
            const doc = await db.collection("customers").doc(p).get();
            if(doc.exists && doc.data().id === id) {
                curPlate = p; 
                document.getElementById('authBox').classList.add('hidden');
                document.getElementById('dash').classList.remove('hidden');
                db.collection("customers").doc(p).onSnapshot(s => render(s.data()));
            } else alert("×¤×¨×˜×™× ×©×’×•×™×™×");
        }

        function render(data) {
            curData = data;
            document.getElementById('statText').innerText = data.status || "×‘×˜×™×¤×•×œ";
            const pending = (data.quotes || []).find(q => !q.signed);
            if(pending) {
                document.getElementById('quoteBox').classList.remove('hidden');
                const tbody = document.getElementById('qTable'); tbody.innerHTML = "";
                pending.items.forEach(i => { tbody.innerHTML += `<tr class="border-b"><td class="p-3">${i.desc}</td><td class="p-3 text-center font-bold">${i.total}â‚ª</td></tr>`; });
                document.getElementById('qTotal').innerText = pending.grandTotal + " â‚ª";
                if(!sPad) sPad = new SignaturePad(document.getElementById('sigPad'));
            } else document.getElementById('quoteBox').classList.add('hidden');
        }

        async function approve() {
            if(sPad.isEmpty()) return alert("× × ×œ×—×ª×•×");
            const sig = sPad.toDataURL();
            const pending = curData.quotes.find(q => !q.signed);
            const updated = curData.quotes.map(q => q.id === pending.id ? {...q, signed: true, signedAt: new Date().toISOString()} : q);
            await db.collection("customers").doc(curPlate).update({ quotes: updated, signatureData: sig, status: "×”×¦×¢×” ××•×©×¨×”" });
            
            const adminPhone = "972506655060", apiKey = "YOUR_API_KEY_HERE";
            const msg = encodeURIComponent(`âœ… ×™× ×™×‘, ${curData.fName} ××™×©×¨ ×”×¦×¢×” ×œ×¨×›×‘ ${curPlate} ×‘×¡×š ${pending.grandTotal}â‚ª.`);
            fetch(`https://api.callmebot.com/whatsapp.php?phone=${adminPhone}&text=${msg}&apikey=${apiKey}`, {mode:'no-cors'});
            
            alert("×”×¦×¢×” ××•×©×¨×”!");
        }
    </script>
</body>
</html>
