<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מרכז שירות ברע״מ | VAG Specialist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .ltr { direction: ltr; display: inline-block; }
        .hero-bg { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; padding: 40px 20px 110px 20px; clip-path: ellipse(150% 100% at 50% 0%); position: relative; }
        .services-grid { margin-top: -70px; padding: 0 15px; position: relative; z-index: 10; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; transition: 0.3s; }
        .review-section { background: #0f172a; color: white; border-radius: 40px 40px 0 0; padding: 40px 20px; margin-top: 40px; }
        .hidden { display: none !important; }
        #sig-canvas { border: 2px dashed #cbd5e1; background: #f1f5f9; width: 100%; cursor: crosshair; }
    </style>
</head>
<body>

    <header class="bg-white p-4 text-center border-b sticky top-0 z-[100]">
        <h1 class="text-2xl font-black text-blue-900 leading-none">מרכז שירות ברע״מ</h1>
        <p class="text-blue-600 font-bold text-sm mt-1">באר שבע</p>
        <div id="liveClock" class="mt-2 bg-blue-50 py-1.5 px-4 rounded-full inline-block border border-blue-100 text-blue-900 font-bold text-xs ltr"></div>
        <div class="mt-2 text-[10px] font-bold text-gray-400 flex items-center justify-center gap-2">
            <i class="far fa-clock"></i>
            <span>א׳-ה׳ <span class="ltr">07:30 - 15:30</span> | ו׳-ש׳: סגור</span>
        </div>
    </header>

    <div id="mainContent">
        <section class="hero-bg text-center">
            <h2 class="text-3xl font-black italic mb-1 uppercase tracking-tighter">מומחי VAG</h2>
            <p class="text-blue-100 text-[10px] font-bold opacity-80 uppercase">Audi • Volkswagen • Skoda • Seat</p>
        </section>

        <div class="services-grid max-w-lg mx-auto grid grid-cols-2 gap-3">
            <div class="card p-4 text-center"><i class="fas fa-laptop-code text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">דיאגנוסטיקה</p></div>
            <div class="card p-4 text-center"><i class="fas fa-cogs text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">גירים DSG</p></div>
            <div class="card p-4 text-center"><i class="fas fa-oil-can text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">טיפולים</p></div>
            <div class="card p-4 text-center"><i class="fas fa-snowflake text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">מיזוג אוויר</p></div>
            <div class="card p-4 text-center"><i class="fas fa-bolt text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">חשמל</p></div>
            <div class="card p-4 text-center"><i class="fas fa-shield-alt text-blue-600 text-xl mb-1"></i><p class="font-bold text-[11px]">הכנה לטסט</p></div>
        </div>

        <div class="px-5 mt-6 max-w-lg mx-auto space-y-4">
            <div class="bg-amber-50 border-r-4 border-amber-400 p-4 rounded-xl flex gap-3">
                <i class="fas fa-lightbulb text-amber-500 mt-1"></i>
                <div><span class="block font-bold text-[10px] text-amber-800 uppercase">טיפ יומי</span><p id="dailyTip" class="text-[11px] text-gray-700"></p></div>
            </div>

            <div class="card p-5 border-2 border-blue-50">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white"><i class="fas fa-robot"></i></div>
                    <span class="font-bold text-sm">Gemini VAG Expert</span>
                </div>
                <div id="aiRes" class="hidden p-3 bg-blue-50 rounded-xl text-[11px] mb-3 border-r-4 border-blue-900 leading-relaxed"></div>
                <div class="relative">
                    <input type="text" id="aiInput" placeholder="מה הבעיה ברכב?" class="w-full p-4 bg-gray-50 rounded-2xl text-xs outline-none">
                    <button onclick="askAI()" class="absolute left-2 top-2 bg-blue-900 text-white w-9 h-9 rounded-xl flex items-center justify-center"><i class="fas fa-paper-plane text-[10px]"></i></button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <a href="tel:086277195" class="bg-green-500 text-white p-4 rounded-2xl font-bold text-center shadow-lg text-sm ltr">08-6277195</a>
                <a href="https://waze.com/ul?q=פנחס החוצב 35 באר שבע" class="bg-white text-gray-700 border p-4 rounded-2xl font-bold text-center text-sm">ניווט למוסך</a>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="navTo('login')" class="bg-blue-900 text-white p-4 rounded-2xl font-bold shadow-lg">אזור אישי</button>
                <button onclick="navTo('register')" class="bg-blue-50 text-blue-900 border border-blue-200 p-4 rounded-2xl font-bold italic underline">הרשמה</button>
            </div>
        </div>

        <section class="review-section">
            <h3 class="text-center font-bold mb-6 italic italic">לקוחות מדרגים 5.0 ★</h3>
            <div id="reviews" class="flex overflow-x-auto gap-4 no-scrollbar pb-6 px-4"></div>
        </section>
    </div>

    <div id="registerPage" class="hidden p-6 max-w-lg mx-auto bg-white min-h-screen">
        <button onclick="navTo('main')" class="mb-6 font-bold text-blue-600"><i class="fas fa-arrow-right ml-2"></i>חזרה</button>
        <h2 class="text-2xl font-black text-blue-900 mb-6 italic">הרשמה למערכת</h2>
        <form id="regForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="rFName" placeholder="שם מלא *" required class="p-4 bg-gray-50 rounded-xl w-full">
                <input type="text" id="rLName" placeholder="שם משפחה *" required class="p-4 bg-gray-50 rounded-xl w-full">
            </div>
            <input type="text" id="rID" placeholder="תעודת זהות *" required class="p-4 bg-gray-50 rounded-xl w-full ltr">
            <input type="tel" id="rPhone" placeholder="טלפון *" required class="p-4 bg-gray-50 rounded-xl w-full ltr">
            <input type="text" id="rAddr" placeholder="כתובת *" required class="p-4 bg-gray-50 rounded-xl w-full">
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="rModel" placeholder="דגם רכב *" required class="p-4 bg-gray-50 rounded-xl w-full">
                <input type="number" id="rYear" placeholder="שנה *" required class="p-4 bg-gray-50 rounded-xl w-full ltr">
            </div>
            <input type="number" id="rKm" placeholder="קילומטר עדכני *" required class="p-4 bg-gray-50 rounded-xl w-full ltr">
            <input type="text" id="rPlate" placeholder="מספר רכב *" required class="p-4 bg-gray-50 rounded-xl w-full font-bold text-center text-xl ltr">
            <button type="button" onclick="handleRegister()" class="w-full bg-blue-900 text-white p-5 rounded-2xl font-black shadow-xl">שלח הרשמה</button>
        </form>
    </div>

    <div id="loginPage" class="hidden p-10 max-w-lg mx-auto text-center min-h-screen">
        <button onclick="navTo('main')" class="text-right block w-full text-blue-600 font-bold mb-10">חזרה</button>
        <h2 class="text-xl font-black mb-6">כניסה למספר רכב</h2>
        <input type="text" id="loginPlate" placeholder="00-000-00" class="w-full p-5 bg-gray-100 rounded-2xl font-black text-center text-2xl ltr mb-4 outline-none border-2 border-transparent focus:border-blue-900">
        <button onclick="handleLogin()" class="w-full bg-blue-900 text-white p-5 rounded-2xl font-black">התחברות</button>
    </div>

    <div id="userPage" class="hidden p-6 max-w-lg mx-auto bg-white min-h-screen pb-20">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black text-blue-900 italic">שלום, <span id="uNameDisplay">אורח</span></h2>
            <button onclick="navTo('main')" class="text-gray-400"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div id="alerts" class="space-y-2 mb-6"></div>

        <div class="card p-5 mb-6 bg-slate-50 border-blue-100">
            <h3 class="text-[10px] font-black text-gray-400 uppercase mb-3">סטטוס רכב נוכחי</h3>
            <div class="grid grid-cols-2 gap-3 text-xs font-bold text-blue-900">
                <div class="bg-white p-3 rounded-xl border">טיפול קודם: <br><span id="uLastS" class="text-gray-400 ltr">--</span></div>
                <div class="bg-white p-3 rounded-xl border">טיפול הבא: <br><span id="uNextS" class="text-gray-400 ltr">--</span></div>
                <div class="bg-white p-3 rounded-xl border">טסט קודם: <br><span id="uLastT" class="text-gray-400 ltr">--</span></div>
                <div class="bg-white p-3 rounded-xl border">טסט הבא: <br><span id="uNextT" class="text-gray-400 ltr">--</span></div>
            </div>
        </div>

        <div class="card p-5 mb-6">
            <h3 class="font-bold text-sm mb-4">קביעת תור למוסך</h3>
            <div class="space-y-3">
                <input type="date" id="apptDate" class="w-full p-3 bg-gray-50 rounded-xl text-sm">
                <select id="apptTime" class="w-full p-3 bg-gray-50 rounded-xl text-sm ltr">
                    <option>07:30</option><option>08:30</option><option>09:30</option><option>10:30</option>
                </select>
                <button onclick="bookAppt()" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold text-xs">שריין תור</button>
                <div id="userAppts" class="mt-4 space-y-2"></div>
            </div>
        </div>

        <div class="card p-5 mb-6 border-amber-200 bg-amber-50/30">
            <h3 class="font-bold text-sm mb-2 italic">הצעות מחיר ממתינות לחתימה</h3>
            <div id="quoteArea" class="space-y-3">
                <p class="text-[10px] text-gray-400 italic">אין הצעות מחיר חדשות...</p>
            </div>
        </div>

        <div class="card p-5">
            <h3 class="font-bold text-sm mb-4">תיבת הודעות</h3>
            <div id="userMsgs" class="space-y-2"></div>
        </div>
    </div>

    <div id="sigModal" class="hidden fixed inset-0 bg-black/80 z-[200] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-md">
            <h3 class="font-black mb-4">אישור וחתימה על הצעה</h3>
            <canvas id="sig-canvas" height="200"></canvas>
            <div class="flex gap-2 mt-4">
                <button onclick="submitSignature()" class="flex-1 bg-green-600 text-white p-4 rounded-xl font-bold">חתום ואשר</button>
                <button onclick="closeSig()" class="flex-1 bg-gray-100 p-4 rounded-xl">ביטול</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG (אותו דבר כמו קודם)
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // LIVE SYSTEM
        function updateClock() {
            const now = new Date();
            document.getElementById('liveClock').innerText = now.toLocaleString('he-IL', { weekday:'long', day:'numeric', month:'long', hour:'2-digit', minute:'2-digit', second:'2-digit'});
        }
        setInterval(updateClock, 1000); updateClock();

        // REVIEWS & TIPS
        const reviewsArr = ["שירות פרימיום!", "ה-VAG שלי רק כאן.", "מקצוענים אמיתיים.", "יניב נותן שירות מעל המצופה.", "אמינות ושקיפות.", "מחיר הוגן.", "עבודה נקייה.", "דיאגנוסטיקה ברמה הכי גבוהה.", "מומלץ בחום!", "הכי טובים בדרום."];
        reviewsArr.forEach(r => document.getElementById('reviews').innerHTML += `<div class="bg-white/5 border border-white/10 p-5 rounded-3xl min-w-[200px] text-center"><div class="text-yellow-400 text-[10px] mb-2">${'<i class="fas fa-star"></i>'.repeat(5)}</div><p class="text-[11px] opacity-80 italic">"${r}"</p></div>`);
        
        const tips = ["בדיקת לחץ אוויר חוסכת דלק.", "גיר DSG דורש החלפת שמן כל 60 אלף.", "אל תמתינו לנורת שמן להידלק.", "מי קירור G13 בלבד לרכבי VAG."];
        document.getElementById('dailyTip').innerText = tips[new Date().getDay() % tips.length];

        // NAVIGATION
        function navTo(p) {
            ['mainContent', 'registerPage', 'loginPage', 'userPage'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if(p === 'main') document.getElementById('mainContent').classList.remove('hidden');
            else document.getElementById(p + 'Page').classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // AUTH & REGISTER
        async function handleRegister() {
            const data = {
                fName: document.getElementById('rFName').value,
                lName: document.getElementById('rLName').value,
                id: document.getElementById('rID').value,
                phone: document.getElementById('rPhone').value,
                plate: document.getElementById('rPlate').value,
                model: document.getElementById('rModel').value,
                year: document.getElementById('rYear').value,
                km: document.getElementById('rKm').value,
                lastS: "טרם", nextS: "טרם", lastT: "טרם", nextT: "טרם",
                messages: [{from: "מערכת", text: "ברוך הבא למרכז שירות ברע״מ!"}],
                quotes: []
            };
            if(!data.plate || !data.fName) { alert("מלא פרטי חובה"); return; }
            await db.collection("customers").doc(data.plate).set(data);
            alert("נרשמת בהצלחה!");
            navTo('login');
        }

        let user = null;
        async function handleLogin() {
            const plate = document.getElementById('loginPlate').value;
            const doc = await db.collection("customers").doc(plate).get();
            if(doc.exists) {
                user = doc.data();
                initUserDashboard();
                navTo('user');
            } else { alert("מספר רכב לא רשום"); }
        }

        function initUserDashboard() {
            document.getElementById('uNameDisplay').innerText = user.fName;
            document.getElementById('uLastS').innerText = user.lastS;
            document.getElementById('uNextS').innerText = user.nextS;
            document.getElementById('uLastT').innerText = user.lastT;
            document.getElementById('uNextT').innerText = user.nextT;
            
            // Season/Test Alerts
            const alerts = document.getElementById('alerts');
            alerts.innerHTML = "";
            const month = new Date().getMonth() + 1;
            if(month >= 11 || month <= 2) alerts.innerHTML += `<div class="bg-blue-900 text-white p-3 rounded-xl text-[10px] animate-pulse">❄️ ביקורת חורף בחינם כעת בברע״מ! הזמן תור.</div>`;
            
            // Load Messages
            document.getElementById('userMsgs').innerHTML = user.messages.map(m => `<div class="p-3 bg-gray-50 rounded-xl border-r-4 border-blue-900 text-[11px]"><b>${m.from}:</b> ${m.text}</div>`).reverse().join('');

            // Load Quotes
            const qArea = document.getElementById('quoteArea');
            if(user.quotes && user.quotes.length > 0) {
                qArea.innerHTML = user.quotes.filter(q => !q.signed).map((q, i) => `
                    <div class="bg-white p-3 rounded-xl border border-amber-200 flex justify-between items-center">
                        <div><p class="text-xs font-bold">${q.title}</p><p class="text-xs text-amber-600 ltr">₪ ${q.price}</p></div>
                        <button onclick="openSig(${i})" class="bg-amber-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold">צפה וחתום</button>
                    </div>
                `).join('');
            }
            loadAppts();
        }

        // APPOINTMENTS
        async function loadAppts() {
            const snap = await db.collection("appointments").where("plate", "==", user.plate).get();
            document.getElementById('userAppts').innerHTML = snap.docs.map(doc => {
                const a = doc.data();
                return `<div class="flex justify-between items-center bg-blue-50 p-3 rounded-xl text-xs">
                    <span>${a.date} | ${a.time}</span>
                    <button onclick="cancelAppt('${doc.id}')" class="text-red-500">ביטול</button>
                </div>`;
            }).join('');
        }

        async function bookAppt() {
            const date = document.getElementById('apptDate').value;
            const time = document.getElementById('apptTime').value;
            if(!date) return;
            await db.collection("appointments").add({ plate: user.plate, date, time, name: user.fName });
            alert("תור נקבע!");
            loadAppts();
        }

        async function cancelAppt(id) {
            if(confirm("לבטל תור זה?")) { await db.collection("appointments").doc(id).delete(); loadAppts(); }
        }

        // SIGNATURE LOGIC
        let activeQuoteIdx = null;
        const canvas = document.getElementById('sig-canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function openSig(idx) { activeQuoteIdx = idx; document.getElementById('sigModal').classList.remove('hidden'); resizeCanvas(); }
        function closeSig() { document.getElementById('sigModal').classList.add('hidden'); }
        
        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth; ctx.strokeStyle = "#1e3a8a"; ctx.lineWidth = 3; }
        
        canvas.addEventListener('mousedown', () => drawing = true);
        window.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mousemove', (e) => {
            if(!drawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });

        async function submitSignature() {
            const sigImg = canvas.toDataURL();
            user.quotes[activeQuoteIdx].signed = true;
            user.quotes[activeQuoteIdx].sigData = sigImg;
            user.quotes[activeQuoteIdx].signedAt = new Date().toISOString();
            
            await db.collection("customers").doc(user.plate).update({ quotes: user.quotes });
            alert("ההצעה אושרה ונחתמה!");
            closeSig();
            initUserDashboard();
        }

        // AI EXPERT
        async function askAI() {
            const input = document.getElementById('aiInput').value;
            const res = document.getElementById('aiRes');
            if(!input) return;
            res.classList.remove('hidden'); res.innerHTML = "המומחה חושב...";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${firebaseConfig.apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `אתה המומחה של מוסך ברע"מ. ענה בקצרה בעברית על VAG: ${input}` }] }] })
                });
                const d = await response.json();
                res.innerHTML = "<b>Gemini:</b> " + d.candidates[0].content.parts[0].text;
            } catch (e) { res.innerHTML = "שגיאה ב-AI."; }
        }
    </script>
</body>
</html>
