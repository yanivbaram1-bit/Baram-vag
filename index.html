<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מרכז שירות ברע״מ | CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; }
        .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 4px; }
        input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; }
        .btn-primary { background: #1e3a8a; color: white; width: 100%; padding: 15px; border-radius: 15px; font-weight: 700; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header class="bg-white p-4 text-center border-b-2 border-slate-200 sticky top-0 z-50">
        <h1 class="text-2xl font-bold text-blue-900">מרכז שירות ברע״מ</h1>
        <p class="text-xs text-slate-500 font-bold">מערכת ניהול לקוחות חכמה</p>
    </header>

    <div class="p-4 max-w-md mx-auto">
        
        <div id="mainMenu">
            <div class="card text-center">
                <i class="fas fa-users-cog text-5xl text-blue-900 mb-4"></i>
                <h2 class="text-xl font-bold mb-6">שלום, כיצד נוכל לעזור?</h2>
                <button onclick="showPage('registerPage')" class="btn-primary mb-3">רישום לקוח חדש במערכת</button>
                <button onclick="showPage('loginPage')" class="w-full border-2 border-blue-900 text-blue-900 p-4 rounded-xl font-bold">כניסה ללקוח רשום</button>
            </div>
        </div>

        <div id="registerPage" class="hidden">
            <h2 class="text-xl font-bold mb-4">טופס רישום לקוח</h2>
            <div class="card">
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group"><label>שם פרטי</label><input type="text" id="regFirst"></div>
                    <div class="input-group"><label>שם משפחה</label><input type="text" id="regLast"></div>
                </div>
                <div class="input-group"><label>טלפון</label><input type="tel" id="regPhone"></div>
                <div class="input-group"><label>כתובת</label><input type="text" id="regAddress"></div>
                <div class="input-group"><label>תעודת זהות</label><input type="number" id="regId"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group"><label>סוג רכב</label><input type="text" id="regCarModel"></div>
                    <div class="input-group"><label>צבע</label><input type="text" id="regColor"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="input-group"><label>מספר רכב</label><input type="text" id="regPlate"></div>
                    <div class="input-group"><label>שנת רכב</label><input type="number" id="regYear"></div>
                </div>
                <div class="input-group"><label>קילומטראז'</label><input type="number" id="regKm"></div>
                <button onclick="handleRegister()" class="btn-primary mt-4 shadow-lg">שמור והצטרף למועדון</button>
                <button onclick="showPage('mainMenu')" class="w-full text-slate-400 mt-4 text-sm">חזרה</button>
            </div>
        </div>

        <div id="loginPage" class="hidden">
            <div class="card">
                <h2 class="text-xl font-bold mb-4">התחברות לאזור האישי</h2>
                <div class="input-group"><label>שם משפחה</label><input type="text" id="loginLast"></div>
                <div class="input-group"><label>מספר רכב</label><input type="text" id="loginPlate"></div>
                <button onclick="handleLogin()" class="btn-primary mt-2">התחבר</button>
                <button onclick="showPage('mainMenu')" class="w-full text-slate-400 mt-4 text-sm">חזרה</button>
            </div>
        </div>

        <div id="clientDashboard" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold italic">שלום, <span id="clientNameDisplay" class="text-blue-700"></span></h2>
                <button onclick="location.reload()" class="text-xs text-red-500">יציאה</button>
            </div>

            <div class="card bg-slate-900 text-white border-b-4 border-blue-500">
                <h3 class="text-xs opacity-60">פרטי רכב במערכת:</h3>
                <p class="text-lg font-bold" id="carInfoDisplay"></p>
                <div class="mt-1 text-xs text-blue-300" id="plateDisplay"></div>
            </div>

            <button onclick="bookWhatsApp()" class="w-full bg-green-500 text-white p-4 rounded-2xl font-bold mb-4 flex items-center justify-center gap-3 shadow-lg">
                <i class="fab fa-whatsapp text-2xl"></i>
                הזמן תור לטיפול עכשיו
            </button>

            <div class="grid grid-cols-2 gap-3">
                <div class="card"><label class="text-blue-600">טיפול אחרון</label><div class="font-bold text-sm" id="lastService"></div></div>
                <div class="card"><label class="text-red-600">טיפול הבא</label><div class="font-bold text-sm" id="nextService"></div></div>
            </div>

            <div class="card"><label class="mb-1 text-xs">פירוט טיפול אחרון:</label><p class="text-sm text-slate-600" id="lastDetails"></p></div>
            <div class="card"><label class="mb-1 text-xs text-red-500 font-bold">נדרש לטיפול הבא:</label><p class="text-sm text-slate-600" id="nextDetails"></p></div>

            <div class="card bg-green-50 border border-green-200">
                <h4 class="font-bold text-xs text-green-800">מבחן רישוי שנתי (טסט)</h4>
                <div class="flex justify-between mt-2 text-xs">
                    <span>אחרון: <b id="lastTest"></b></span>
                    <span class="text-red-600">פג תוקף: <b id="nextTest"></b></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;

        function showPage(pageId) {
            ['mainMenu', 'registerPage', 'loginPage', 'clientDashboard'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        function handleRegister() {
            const plate = document.getElementById('regPlate').value;
            const data = {
                firstName: document.getElementById('regFirst').value,
                lastName: document.getElementById('regLast').value,
                phone: document.getElementById('regPhone').value,
                address: document.getElementById('regAddress').value,
                tz: document.getElementById('regId').value,
                carModel: document.getElementById('regCarModel').value,
                color: document.getElementById('regColor').value,
                plate: plate,
                year: document.getElementById('regYear').value,
                km: document.getElementById('regKm').value,
                lastServiceDate: "טרם עודכן",
                nextServiceDate: "יקבע בביקור",
                lastServiceWork: "נרשם למערכת",
                nextServiceWork: "בדיקה כללית",
                lastTestDate: "--",
                nextTestDate: "--"
            };

            db.collection("customers").doc(plate).set(data).then(() => {
                alert("ברוך הבא למשפחת ברע״מ!");
                showPage('mainMenu');
            });
        }

        function handleLogin() {
            const plate = document.getElementById('loginPlate').value;
            const lastName = document.getElementById('loginLast').value;

            db.collection("customers").doc(plate).get().then((doc) => {
                if (doc.exists && doc.data().lastName === lastName) {
                    currentUser = doc.data();
                    document.getElementById('clientNameDisplay').innerText = currentUser.firstName;
                    document.getElementById('carInfoDisplay').innerText = currentUser.carModel + " | " + currentUser.year;
                    document.getElementById('plateDisplay').innerText = "מספר רכב: " + currentUser.plate;
                    document.getElementById('lastService').innerText = currentUser.lastServiceDate;
                    document.getElementById('nextService').innerText = currentUser.nextServiceDate;
                    document.getElementById('lastDetails').innerText = currentUser.lastServiceWork;
                    document.getElementById('nextDetails').innerText = currentUser.nextServiceWork;
                    document.getElementById('lastTest').innerText = currentUser.lastTestDate;
                    document.getElementById('nextTest').innerText = currentUser.nextTestDate;
                    showPage('clientDashboard');
                } else {
                    alert("פרטי כניסה שגויים");
                }
            });
        }

        function bookWhatsApp() {
            if(!currentUser) return;
            const msg = `שלום למרכז שירות ברע"מ, אני מעוניין להזמין תור לטיפול.%0A%0A*פרטי לקוח:*%0Aשם: ${currentUser.firstName} ${currentUser.lastName}%0Aרכב: ${currentUser.carModel} (${currentUser.year})%0Aמספר רכב: ${currentUser.plate}%0Aקילומטראז': ${currentUser.km}`;
            window.open(`https://wa.me/972505858750?text=${msg}`, '_blank');
        }
    </script>
</body>
</html>
