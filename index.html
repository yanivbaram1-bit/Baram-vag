<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מרכז שירות ברע״מ בע״מ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; margin: 0; }
        .hero-bg { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; }
        header { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 15px; background: white; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .service-box { background: white; border-radius: 15px; padding: 15px; text-align: center; border: 1px solid #cbd5e1; transition: all 0.3s; }
        .service-box i { font-size: 1.8rem; color: #2563eb; margin-bottom: 5px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .ai-chat-box { background: #f8fafc; border: 2px solid #3b82f6; border-radius: 15px; padding: 15px; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; margin-bottom: 8px; font-size: 14px; }
    </style>
</head>
<body>

    <header>
        <div id="userGreeting" class="text-[11px] font-bold text-blue-600 truncate px-2"></div>
        <h1 class="text-lg font-extrabold text-blue-900 text-center">מרכז שירות ברע״מ בע״מ</h1>
        <div class="text-left px-2">
            <button id="logoutBtn" onclick="location.reload()" class="hidden text-red-600 text-[10px] font-black bg-red-50 px-2 py-1 rounded-full border border-red-200">יציאה</button>
        </div>
    </header>

    <div id="homePage">
        <section class="hero-bg pt-6 pb-14 px-6 text-center">
            <h2 class="text-xl font-bold mb-1">VAG SPECIALIST SYSTEM</h2>
            <p class="text-blue-100 text-xs mb-6">מומחים לאבחון ותיקון ברמת יצרן</p>
            <div class="grid grid-cols-3 gap-2 max-w-sm mx-auto">
                <a href="tel:086277195" class="bg-white text-blue-900 rounded-lg p-3 text-xs font-bold shadow-lg"><i class="fas fa-phone ml-1"></i>חיוג</a>
                <a href="https://waze.com/ul?q=פנחס החוצב 35 באר שבע" class="bg-white text-blue-900 rounded-lg p-3 text-xs font-bold shadow-lg"><i class="fab fa-waze text-blue-400 ml-1"></i>ניווט</a>
                <a href="https://wa.me/972505858750" class="bg-white text-blue-900 rounded-lg p-3 text-xs font-bold shadow-lg"><i class="fab fa-whatsapp text-green-500 ml-1"></i>הודעה</a>
            </div>
        </section>

        <div class="max-w-md mx-auto px-4 -mt-8 relative z-10">
            <div id="authButtons" class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="showPage('loginPage')" class="card p-4 text-center border-b-4 border-blue-600 font-bold text-sm"><i class="fas fa-sign-in-alt mb-1 block text-blue-600"></i>כניסת לקוח</button>
                <button onclick="showPage('registerPage')" class="card p-4 text-center border-b-4 border-slate-700 font-bold text-sm"><i class="fas fa-id-card mb-1 block text-slate-700"></i>פתיחת כרטיס</button>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="service-box"><i class="fas fa-microchip"></i><p class="text-xs font-bold">דיאגנוסטיקה</p></div>
                <div class="service-box"><i class="fas fa-wrench"></i><p class="text-xs font-bold">טיפול תקופתי</p></div>
                <div class="service-box"><i class="fas fa-cog"></i><p class="text-xs font-bold">גירים DSG</p></div>
                <div class="service-box"><i class="fas fa-snowflake"></i><p class="text-xs font-bold">מיזוג אוויר</p></div>
            </div>

            <div class="card p-5 mb-10 border-r-4 border-blue-500">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fas fa-robot text-blue-600"></i>
                    <h3 class="font-bold text-sm">המומחה הווירטואלי של ברע״מ</h3>
                </div>
                <input type="text" id="aiInput" placeholder="מה התקלה ברכב שלך?" class="mb-2 bg-slate-50 border-blue-200">
                <button onclick="askExpertAI()" id="aiBtn" class="w-full bg-blue-900 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-md">שאל את המומחה</button>
                <div id="aiResponse" class="hidden mt-4 p-4 bg-blue-50 rounded-xl text-sm border-r-4 border-blue-300"></div>
            </div>
        </div>
    </div>

    <div id="registerPage" class="hidden p-5 max-w-md mx-auto">
        <button onclick="showPage('homePage')" class="mb-4 text-blue-900 font-bold"><i class="fas fa-chevron-right ml-1"></i> חזרה</button>
        <div class="card p-6">
            <h2 class="text-xl font-black mb-6 text-blue-900 border-b pb-2 text-center">רישום לקוח ורכב</h2>
            <div class="space-y-1">
                <input type="text" id="regFirst" placeholder="שם פרטי">
                <input type="text" id="regLast" placeholder="שם משפחה">
                <input type="number" id="regId" placeholder="תעודת זהות">
                <input type="tel" id="regPhone" placeholder="טלפון">
                <input type="text" id="regAddress" placeholder="כתובת מגורים">
                <hr class="my-3">
                <input type="text" id="regPlate" placeholder="מספר רכב">
                <input type="text" id="regCarModel" placeholder="דגם רכב (למשל: סקודה אוקטביה)">
                <input type="number" id="regYear" placeholder="שנת ייצור">
                <input type="text" id="regColor" placeholder="צבע">
                <input type="number" id="regKm" placeholder="קילומטראז' נוכחי">
                <button onclick="handleRegister()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-black mt-4 shadow-lg uppercase">שמור ופתח כרטיס</button>
            </div>
        </div>
    </div>

    <div id="loginPage" class="hidden p-5 max-w-md mx-auto">
        <button onclick="showPage('homePage')" class="mb-4 text-blue-900 font-bold"><i class="fas fa-chevron-right ml-1"></i> חזרה</button>
        <div class="card p-6">
            <h2 class="text-xl font-black mb-6 text-blue-900 border-b pb-2 text-center">כניסה לאזור אישי</h2>
            <input type="text" id="loginLast" placeholder="שם משפחה">
            <input type="text" id="loginPlate" placeholder="מספר רכב">
            <button onclick="handleLogin()" class="w-full bg-blue-900 text-white py-4 rounded-xl font-black mt-2">התחבר</button>
        </div>
    </div>

    <div id="clientDashboard" class="hidden p-5 max-w-md mx-auto">
        <div class="card bg-slate-900 text-white p-6 mb-4">
            <p id="carTitle" class="text-xl font-black"></p>
            <p id="carPlateSub" class="text-blue-400 font-mono text-sm tracking-widest"></p>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="card p-4 text-center"><p class="text-[10px] text-blue-500 font-black uppercase">טיפול אחרון</p><b id="lastDate" class="text-xs"></b></div>
            <div class="card p-4 text-center"><p class="text-[10px] text-red-500 font-black uppercase">טיפול הבא</p><b id="nextDate" class="text-xs"></b></div>
        </div>
        <div class="card p-4 mb-4"><h4 class="text-[10px] font-black opacity-50 mb-1">פירוט עבודה אחרונה:</h4><p id="lastWork" class="text-sm font-bold"></p></div>
        <button onclick="bookWhatsApp()" class="w-full bg-green-600 text-white py-4 rounded-xl font-black flex items-center justify-center gap-2 shadow-lg"><i class="fab fa-whatsapp"></i> תאם ביקור במוסך</button>
    </div>

    <script>
        // חיבור Firebase שלך
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentUser = null;

        function showPage(id) {
            ['homePage', 'registerPage', 'loginPage', 'clientDashboard'].forEach(p => document.getElementById(p).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // לוגיקת AI משופרת משמעותית
        async function askExpertAI() {
            const input = document.getElementById('aiInput').value.trim();
            const resDiv = document.getElementById('aiResponse');
            const btn = document.getElementById('aiBtn');
            if(!input) return;

            btn.innerText = "מנתח נתונים...";
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = "<i class='fas fa-sync fa-spin'></i> בודק קודי תקלות יצרן...";

            setTimeout(() => {
                let lowerInput = input.toLowerCase();
                let response = "";

                // בדיקה אם השאלה בכלל קשורה לרכב
                const carKeywords = ["מנוע", "גיר", "שמן", "נורה", "רעש", "ברקס", "טיפול", "טורבו", "dsg", "epc", "רכב", "אאודי", "פולקסווגן", "סקודה", "סיאט", "הנעה"];
                const isCarRelated = carKeywords.some(kw => lowerInput.includes(kw));

                if (!isCarRelated) {
                    response = "נראה שהשאלה שלך לא קשורה לתחום הרכב. אני מומחה לאבחון תקלות בקבוצת VAG (אאודי, פולקסווגן, סקודה וסיאט). איך אוכל לעזור לך עם הרכב היום?";
                } else if (lowerInput.includes("מנורה") || lowerInput.includes("נורה") || lowerInput.includes("epc")) {
                    response = "<b>אבחון מנורת התראה:</b> ברכבי הקבוצה, מנורת EPC או מנוע מצביעה על תקלה במערכת ניהול המנוע. <b>סיבות נפוצות:</b> סלילי הצתה (Coils) תקולים, חיישן חמצן, או בריחת גדישה מהטורבו. חובה לחבר סורק ODIS מקורי לאיתור קוד התקלה המדויק.";
                } else if (lowerInput.includes("גיר") || lowerInput.includes("dsg") || lowerInput.includes("רעידות")) {
                    response = "<b>אבחון מערכת DSG:</b> רעידות בתחילת נסיעה או נקישות בהעברת הילוכים מעידות לרוב על בלאי במצמדים (Clutches) או צורך בכיול מכטרוניקס. אנחנו במרכז שירות ברע״מ מומחים בשיפוץ גירים אלו.";
                } else if (lowerInput.includes("שמן") || lowerInput.includes("טיפול")) {
                    response = "<b>תחזוקה מונעת:</b> מנועי TSI/TFSI רגישים מאוד לאיכות השמן. אנו משתמשים רק בשמן בתקן יצרן 504.00/507.00. מומלץ לבצע טיפול כל 10,000 ק״מ או שנה כדי לשמור על הטורבו.";
                } else {
                    response = "נשמע שיש תקלה שדורשת אבחון פיזי. רכבי VAG דורשים דיוק גרמני וציוד ייעודי. בוא אלינו למוסך בבאר שבע, נחבר סורק מחשב ונראה מה הרכב מדווח בזיכרון התקלות.";
                }

                resDiv.innerHTML = "<b>תשובת מומחה ברע״מ:</b><br>" + response;
                btn.innerText = "שאלה נוספת";
            }, 1500);
        }

        function handleRegister() {
            const plate = document.getElementById('regPlate').value;
            if(!plate) { alert("חובה להזין מספר רכב"); return; }
            const data = {
                firstName: document.getElementById('regFirst').value,
                lastName: document.getElementById('regLast').value,
                id: document.getElementById('regId').value,
                phone: document.getElementById('regPhone').value,
                address: document.getElementById('regAddress').value,
                plate: plate,
                carModel: document.getElementById('regCarModel').value,
                year: document.getElementById('regYear').value,
                color: document.getElementById('regColor').value,
                km: document.getElementById('regKm').value,
                lastServiceDate: "חדש במערכת", nextServiceDate: "בתיאום", lastServiceWork: "פתיחת כרטיס ראשונית"
            };
            db.collection("customers").doc(plate).set(data).then(() => {
                alert("הפרטים נשמרו! ברוך הבא למרכז שירות ברע״מ בע״מ");
                showPage('homePage');
            });
        }

        function handleLogin() {
            const plate = document.getElementById('loginPlate').value;
            const lastName = document.getElementById('loginLast').value;
            db.collection("customers").doc(plate).get().then(doc => {
                if (doc.exists && doc.data().lastName === lastName) {
                    currentUser = doc.data();
                    document.getElementById('userGreeting').innerText = "שלום, " + currentUser.firstName;
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    document.getElementById('authButtons').classList.add('hidden');
                    document.getElementById('carTitle').innerText = currentUser.carModel + " " + (currentUser.year || "");
                    document.getElementById('carPlateSub').innerText = currentUser.plate;
                    document.getElementById('lastDate').innerText = currentUser.lastServiceDate;
                    document.getElementById('nextDate').innerText = currentUser.nextServiceDate;
                    document.getElementById('lastWork').innerText = currentUser.lastServiceWork;
                    showPage('clientDashboard');
                } else { alert("לא נמצא רכב כזה במערכת"); }
            });
        }

        function bookWhatsApp() {
            const msg = `שלום, כאן ${currentUser.firstName}, מעוניין לתאם טיפול לרכב ${currentUser.plate}.`;
            window.open(`https://wa.me/972505858750?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
