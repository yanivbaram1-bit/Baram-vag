<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baram VAG - Admin Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-blur: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="min-h-screen">

    <div id="adminAuth" class="fixed inset-0 z-[1000] bg-slate-900 flex items-center justify-center p-6">
        <div class="glass p-8 rounded-[2rem] w-full max-w-sm text-center">
            <i class="fas fa-user-shield text-4xl text-blue-400 mb-4"></i>
            <h2 class="text-2xl font-black mb-6">כניסת מנהל - ברע״מ</h2>
            <input id="adminEmail" type="email" placeholder="אימייל מנהל" class="w-full p-4 bg-slate-800 rounded-2xl mb-3 border border-slate-700 outline-none">
            <input id="adminPass" type="password" placeholder="סיסמה" class="w-full p-4 bg-slate-800 rounded-2xl mb-6 border border-slate-700 outline-none">
            <button onclick="adminLogin()" class="w-full bg-blue-600 hover:bg-blue-500 p-4 rounded-2xl font-black transition-all">התחבר למערכת</button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <nav class="glass sticky top-0 z-50 p-4 flex justify-between items-center px-8">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center font-black">B</div>
                <h1 class="text-xl font-black tracking-tight">Baram VAG <span class="text-blue-400">Admin</span></h1>
            </div>
            <button onclick="firebase.auth().signOut(); location.reload();" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </nav>

        <main class="p-4 md:p-8 max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-black">רכבים בטיפול / תורים</h3>
                    <div class="flex gap-2">
                        <span class="bg-green-500/20 text-green-400 status-badge">8 פתוחים</span>
                        <span class="bg-blue-500/20 text-blue-400 status-badge">3 תורים היום</span>
                    </div>
                </div>

                <div id="customerList" class="grid gap-4">
                    <div class="text-center p-20 opacity-20"><i class="fas fa-spinner fa-spin text-3xl"></i></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="glass p-6 rounded-[2rem]">
                    <h4 class="font-bold mb-4 text-blue-400"><i class="fas fa-bolt ml-2"></i>פעולות מהירות</h4>
                    <button onclick="alert('בפיתוח: שליחת SMS לכל הלקוחות')" class="w-full text-right p-4 hover:bg-white/5 rounded-2xl transition-all border-b border-white/5 flex justify-between items-center">
                        <span>שלח הודעה לכולם</span>
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
                    <button onclick="updateGarageStatus()" class="w-full text-right p-4 hover:bg-white/5 rounded-2xl transition-all border-b border-white/5 flex justify-between items-center">
                        <span>שינוי סטטוס מוסך (עמוס)</span>
                        <i class="fas fa-clock text-xs"></i>
                    </button>
                </div>

                <div class="glass p-6 rounded-[2rem]">
                    <h4 class="font-bold mb-4 text-green-400"><i class="fas fa-chart-line ml-2"></i>סיכום יומי</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <p class="text-2xl font-black">12</p>
                            <p class="text-[10px] text-gray-400 uppercase">לקוחות רשומים</p>
                        </div>
                        <div class="text-center p-4 bg-white/5 rounded-2xl">
                            <p class="text-2xl font-black">4</p>
                            <p class="text-[10px] text-gray-400 uppercase">הצעות שאושרו</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="quoteModal" class="hidden fixed inset-0 z-[2000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-md">
            <h2 class="text-2xl font-black mb-2 text-blue-400">הצעת מחיר חדשה</h2>
            <p id="targetCar" class="text-xs text-gray-400 mb-6"></p>
            <div class="space-y-4">
                <input id="qTitle" type="text" placeholder="תיאור התיקון (למשל: החלפת קלאצ'ים DSG)" class="w-full p-4 bg-slate-800 rounded-2xl border border-slate-700 outline-none">
                <input id="qPrice" type="number" placeholder="סכום כולל (₪)" class="w-full p-4 bg-slate-800 rounded-2xl border border-slate-700 outline-none">
                <button onclick="sendQuoteToClient()" class="w-full bg-green-600 hover:bg-green-500 p-4 rounded-2xl font-black shadow-lg shadow-green-900/20">שלח לחתימת לקוח</button>
                <button onclick="closeQuoteModal()" class="w-full text-gray-500 text-xs font-bold">ביטול</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG (אותו דבר כמו בדף לקוח)
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let activePlate = null;

        // 1. SECURITY: Admin Login
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                document.getElementById('adminAuth').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadCustomers();
            } catch (e) { alert("גישה נדחתה: משתמש לא מורשה"); }
        }

        // 2. LOAD CUSTOMERS REAL-TIME
        function loadCustomers() {
            db.collection("customers").onSnapshot(snapshot => {
                const list = document.getElementById('customerList');
                list.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasPendingQuote = data.quotes && data.quotes.some(q => !q.signed);
                    const isSigned = data.quotes && data.quotes.some(q => q.signed);

                    list.innerHTML += `
                        <div class="glass p-6 rounded-[2rem] flex flex-col md:flex-row justify-between items-center gap-4 hover:border-blue-500/50 transition-all">
                            <div class="flex items-center gap-4 w-full">
                                <div class="w-14 h-14 bg-slate-800 rounded-2xl flex items-center justify-center text-blue-400 border border-white/5">
                                    <i class="fas fa-car text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <h4 class="font-black text-lg">${data.fName}</h4>
                                    <p class="text-xs text-gray-400 ltr">${data.plate} | ${data.model || 'VAG Model'}</p>
                                </div>
                            </div>
                            
                            <div class="flex gap-2 w-full md:w-auto">
                                ${hasPendingQuote ? '<span class="bg-amber-500/20 text-amber-400 status-badge">ממתין לחתימה</span>' : ''}
                                ${isSigned ? '<span class="bg-green-500/20 text-green-400 status-badge">מאושר לביצוע</span>' : ''}
                            </div>

                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="openQuoteModal('${data.plate}')" class="flex-1 md:flex-none bg-blue-600/20 text-blue-400 px-4 py-2 rounded-xl text-xs font-bold border border-blue-500/30">
                                    הצעת מחיר
                                </button>
                                <button onclick="deleteCustomer('${data.plate}')" class="p-2 text-red-900 hover:text-red-500 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // 3. QUOTE SYSTEM
        function openQuoteModal(plate) {
            activePlate = plate;
            document.getElementById('targetCar').innerText = "שליחת הצעה לרכב: " + plate;
            document.getElementById('quoteModal').classList.remove('hidden');
        }

        async function sendQuoteToClient() {
            const title = document.getElementById('qTitle').value;
            const price = document.getElementById('qPrice').value;
            if(!title || !price) return alert("מלא את כל הפרטים");

            const newQuote = {
                id: Date.now(),
                title: title,
                total: price,
                signed: false,
                date: new Date().toLocaleDateString()
            };

            await db.collection("customers").doc(activePlate).update({
                quotes: firebase.firestore.FieldValue.arrayUnion(newQuote)
            });

            alert("ההצעה נשלחה לנייד של הלקוח!");
            closeQuoteModal();
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.add('hidden');
            document.getElementById('qTitle').value = "";
            document.getElementById('qPrice').value = "";
        }

        async function deleteCustomer(plate) {
            if(confirm("למחוק את הלקוח וההיסטוריה שלו?")) {
                await db.collection("customers").doc(plate).delete();
            }
        }
    </script>
</body>
</html>
