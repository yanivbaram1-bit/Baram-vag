<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול מרכז שירות ברע"מ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="flex">

    <aside class="w-64 bg-slate-900 text-white min-h-screen p-6 fixed">
        <h1 class="text-2xl font-black italic mb-10 text-blue-500 text-center">BARAM VAG</h1>
        <nav class="space-y-4">
            <button onclick="tab('clients')" class="w-full text-right p-3 hover:bg-slate-800 rounded">לקוחות רשומים</button>
            <button onclick="tab('garage')" class="w-full text-right p-3 hover:bg-slate-800 rounded">רכבים במוסך</button>
            <button onclick="tab('quotes')" class="w-full text-right p-3 hover:bg-slate-800 rounded">הצעות מחיר</button>
        </nav>
    </aside>

    <main class="mr-64 p-10 w-full">
        <div id="clients" class="tab-content active">
            <h2 class="text-3xl font-black mb-6 italic">לקוחות במערכת</h2>
            <div class="bg-white rounded-3xl shadow-sm overflow-hidden">
                <table class="w-full text-right text-sm">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-4">שם לקוח</th><th class="p-4">מספר רכב</th><th class="p-4">טלפון</th><th class="p-4">פעולות</th></tr>
                    </thead>
                    <tbody id="clientList"></tbody>
                </table>
            </div>
        </div>

        <div id="garage" class="tab-content">
            <h2 class="text-3xl font-black mb-6 italic">סטטוס עבודה במוסך</h2>
            <div id="garageCards" class="grid grid-cols-3 gap-6"></div>
        </div>

        <div id="quotes" class="tab-content">
            <h2 class="text-3xl font-black mb-6 italic text-blue-900">בניית הצעת מחיר מקצועית</h2>
            <div class="bg-white p-10 rounded-3xl shadow-lg border border-blue-50">
                <select id="selClient" class="w-full p-4 bg-slate-50 border rounded-2xl mb-6 font-bold"></select>
                <div id="rows" class="space-y-3 mb-6">
                    <div class="flex gap-2 quote-row">
                        <input type="text" placeholder="תיאור העבודה/חלק" class="flex-[3] p-3 border rounded-xl desc">
                        <input type="number" placeholder="מחיר" class="w-32 p-3 border rounded-xl price">
                    </div>
                </div>
                <button onclick="addRow()" class="text-blue-600 font-bold mb-6">+ הוסף שורה</button>
                <button onclick="sendQuote()" class="w-full bg-slate-900 text-white p-5 rounded-2xl font-black italic">שלח הצעה לחתימה בטלפון</button>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function tab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        db.collection("customers").onSnapshot(snap => {
            const list = document.getElementById('clientList'); list.innerHTML = "";
            const cards = document.getElementById('garageCards'); cards.innerHTML = "";
            const sel = document.getElementById('selClient'); sel.innerHTML = '<option>בחר לקוח...</option>';
            
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<tr class="border-b"><td class="p-4 font-bold">${d.fName} ${d.lName}</td><td class="p-4">${doc.id}</td><td class="p-4">${d.phone}</td><td class="p-4"><button class="bg-blue-100 px-3 py-1 rounded">כרטיס</button></td></tr>`;
                sel.innerHTML += `<option value="${doc.id}">${d.fName} - ${doc.id}</option>`;
                
                if(d.status && d.status !== "רשום במערכת") {
                    cards.innerHTML += `<div class="bg-white p-6 rounded-2xl shadow-sm border-r-4 border-blue-500"><h4 class="font-black">${d.fName} | ${doc.id}</h4><p class="text-blue-600 font-bold text-xs mt-2">${d.status}</p><select onchange="updateStat('${doc.id}', this.value)" class="mt-4 w-full p-2 border rounded text-xs"><option>עדכן סטטוס...</option><option value="בעבודה">בעבודה</option><option value="ממתין לחלקים">ממתין לחלקים</option><option value="מוכן לאיסוף">מוכן לאיסוף</option></select></div>`;
                }
            });
        });

        function addRow() {
            const div = document.createElement('div'); div.className = "flex gap-2 quote-row";
            div.innerHTML = `<input type="text" placeholder="תיאור" class="flex-[3] p-3 border rounded-xl desc"><input type="number" placeholder="מחיר" class="w-32 p-3 border rounded-xl price">`;
            document.getElementById('rows').appendChild(div);
        }

        async function updateStat(plate, stat) {
            await db.collection("customers").doc(plate).update({ status: stat });
        }

        async function sendQuote() {
            const plate = document.getElementById('selClient').value;
            const rows = document.querySelectorAll('.quote-row');
            let items = [], total = 0;
            rows.forEach(r => {
                const d = r.querySelector('.desc').value, p = r.querySelector('.price').value;
                if(d && p) { items.push({desc: d, total: p}); total += parseFloat(p); }
            });
            const quote = { id: Date.now(), items, grandTotal: total, signed: false };
            await db.collection("customers").doc(plate).update({ quotes: firebase.firestore.FieldValue.arrayUnion(quote), status: "ממתין לאישור הצעה" });
            alert("ההצעה הופיעה בטלפון של הלקוח!");
        }
    </script>
</body>
</html>
