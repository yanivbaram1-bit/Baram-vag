<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ניהול ברע״מ | VAG Admin Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; }
        .ltr { direction: ltr; display: inline-block; }
        .active-tab { color: #001e50; border-bottom: 3px solid #001e50; }
        .client-card { border-radius: 2rem; border: 1px solid #f1f5f9; box-shadow: 0 4px 15px rgba(0,0,0,0.02); transition: 0.3s; }
        .client-card:active { transform: scale(0.98); }
        input { font-size: 16px !important; }
    </style>
</head>
<body class="pb-32">

    <div id="loginOverlay" class="fixed inset-0 bg-[#001e50] z-[1000] flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[3rem] w-full max-w-sm text-center shadow-2xl">
            <h1 class="text-3xl font-black italic mb-2 tracking-tighter">ADMIN ACCESS</h1>
            <p class="text-[10px] text-gray-400 font-bold mb-10 uppercase tracking-widest">Baram VAG Management</p>
            <input id="passInput" type="password" placeholder="••••••••" class="w-full p-5 bg-slate-50 rounded-2xl text-center text-2xl ltr mb-6 border-none ring-1 ring-slate-100">
            <button onclick="checkPass()" class="w-full bg-[#001e50] text-white p-6 rounded-[2rem] font-black shadow-xl active:scale-95 transition">כניסה למערכת</button>
        </div>
    </div>

    <header class="bg-[#001e50] text-white p-6 pt-12 rounded-b-[3rem] shadow-xl sticky top-0 z-50">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-black italic">ניהול ברע״מ</h2>
            <button onclick="logoutAdmin()" class="opacity-50"><i class="fas fa-power-off"></i></button>
        </div>
        <div class="relative">
            <input type="text" id="mainSearch" onkeyup="filterClients()" placeholder="חיפוש לקוח / מספר רכב..." class="w-full p-5 bg-white/10 rounded-2xl text-white placeholder:text-white/40 outline-none border border-white/10 pr-12">
            <i class="fas fa-search absolute right-5 top-1/2 -translate-y-1/2 text-white/30"></i>
        </div>
    </header>

    <main class="p-5 max-w-md mx-auto space-y-4" id="clientsList">
        </main>

    <div id="explorer" class="fixed inset-0 bg-slate-50 z-[100] hidden flex flex-col">
        <header class="bg-white p-6 pt-12 border-b flex justify-between items-center">
            <div>
                <h3 id="expName" class="text-xl font-black text-[#001e50]"></h3>
                <p id="expPlate" class="text-[10px] font-black text-gray-400 ltr"></p>
            </div>
            <button onclick="closeExplorer()" class="text-2xl text-gray-300 px-4">&times;</button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="prepQuote()" class="bg-blue-600 text-white p-5 rounded-3xl font-black text-xs shadow-lg"><i class="fas fa-plus ml-2"></i> שלח הצעה</button>
                <button onclick="prepEdit()" class="bg-white border text-slate-800 p-5 rounded-3xl font-black text-xs shadow-sm"><i class="fas fa-edit ml-2"></i> ערוך פרטים</button>
            </div>

            <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm">
                <h4 class="text-[10px] font-black text-gray-300 uppercase mb-4">פרטי קשר ורכב</h4>
                <p id="expPhone" class="text-sm font-black text-slate-700 ltr"></p>
                <p id="expModel" class="text-xs font-bold text-slate-400 mt-1"></p>
            </div>

            <div id="sigView" class="hidden bg-green-50 p-6 rounded-[2rem] border border-green-100">
                <p class="text-[9px] font-black text-green-600 uppercase mb-4">חתימה מאושרת מהלקוח</p>
                <img id="sigImg" class="w-full bg-white rounded-2xl border border-green-200">
            </div>

            <div class="bg-white p-6 rounded-[2rem] shadow-sm">
                <h4 class="text-[10px] font-black text-gray-300 uppercase mb-4 italic">היסטוריה (ללא הגבלה)</h4>
                <div id="expHistory" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Admin Security
        function checkPass() {
            if(document.getElementById('passInput').value === "baram!14567") {
                localStorage.setItem('adminAuth', new Date().getTime() + 86400000);
                location.reload();
            } else alert("סיסמה שגויה");
        }

        window.onload = () => {
            if(localStorage.getItem('adminAuth') > new Date().getTime()) {
                document.getElementById('loginOverlay').classList.add('hidden');
                loadAdminData();
            }
        };

        let activePlate = null;
        let allClients = [];

        function loadAdminData() {
            db.collection("customers").onSnapshot(snap => {
                const cont = document.getElementById('clientsList');
                cont.innerHTML = "";
                allClients = [];

                snap.forEach(doc => {
                    const data = doc.data();
                    allClients.push(data);
                    
                    const hasAction = data.pendingQuote && data.pendingQuote.signed;

                    cont.innerHTML += `
                        <div onclick="openExplorer('${data.plate}')" class="client-card bg-white p-6 flex justify-between items-center ${hasAction ? 'ring-2 ring-green-500' : ''}">
                            <div>
                                <h3 class="font-black text-slate-800">${data.fName} ${data.lName}</h3>
                                <p class="text-[10px] font-bold text-slate-400 ltr mt-1">${data.plate} | ${data.model}</p>
                            </div>
                            <div class="text-left">
                                ${hasAction ? '<span class="bg-green-100 text-green-600 text-[8px] font-black px-3 py-1 rounded-full animate-pulse">חתימה חדשה!</span>' : '<i class="fas fa-chevron-left text-gray-200"></i>'}
                            </div>
                        </div>
                    `;
                });
            });
        }

        function openExplorer(plate) {
            activePlate = plate;
            const user = allClients.find(u => u.plate === plate);
            document.getElementById('explorer').classList.remove('hidden');
            document.getElementById('expName').innerText = `${user.fName} ${user.lName}`;
            document.getElementById('expPlate').innerText = user.plate;
            document.getElementById('expPhone').innerText = user.phone;
            document.getElementById('expModel').innerText = `${user.model} | ${user.year} | ${user.km || 0} ק"מ`;
            
            if(user.pendingQuote && user.pendingQuote.signed) {
                document.getElementById('sigView').classList.remove('hidden');
                document.getElementById('sigImg').src = user.pendingQuote.sigData;
            } else {
                document.getElementById('sigView').classList.add('hidden');
            }

            renderHistory(user);
        }

        function renderHistory(user) {
            const h = document.getElementById('expHistory');
            h.innerHTML = "";
            const items = [...(user.history.quotes || []), ...(user.history.services || [])].sort((a,b) => new Date(b.date) - new Date(a.date));
            
            items.forEach(item => {
                h.innerHTML += `
                    <div class="p-4 bg-slate-50 rounded-2xl flex justify-between items-center">
                        <p class="text-[11px] font-bold">${item.title || item.desc}</p>
                        <p class="text-[9px] text-gray-400 ltr">${item.date}</p>
                    </div>
                `;
            });
        }

        async function prepQuote() {
            const txt = prompt("הזן תיאור הצעה ומחיר סופי:");
            if(!txt) return;
            await db.collection("customers").doc(activePlate).update({
                "pendingQuote": { details: txt, signed: false },
                "lastAction": "הצעה נשלחה"
            });
            alert("ההצעה הופיעה עכשיו אצל הלקוח בנייד!");
        }

        function closeExplorer() { document.getElementById('explorer').classList.add('hidden'); }
        function logoutAdmin() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
