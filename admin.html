<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ניהול ברע״מ PRO | VAG Specialist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; }
        .glass-header { background: rgba(0, 30, 80, 0.95); backdrop-filter: blur(10px); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 2rem 2rem 0 0; padding: 2rem; max-height: 90vh; overflow-y: auto; }
        input, select { border: 1px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; outline: none; font-size: 16px !important; }
        .btn-primary { background: #001e50; color: white; padding: 15px; border-radius: 15px; font-weight: 800; text-align: center; width: 100%; }
    </style>
</head>
<body class="pb-20">

    <header class="glass-header text-white p-6 pt-10 sticky top-0 z-[1000] rounded-b-[2rem] shadow-2xl">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-black italic">ניהול ברע״מ PRO</h1>
            <button onclick="openAddClient()" class="w-12 h-12 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg active:scale-90">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <input type="text" id="adminSearch" onkeyup="filterClients()" placeholder="חיפוש לקוח או רכב..." class="bg-white/10 border-none text-white placeholder:text-white/40">
    </header>

    <main class="p-4 space-y-3" id="clientsContainer">
        <div class="text-center py-20 opacity-30 italic">טוען נתונים...</div>
    </main>

    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-black mb-4">הוספת לקוח חדש</h2>
            <div class="space-y-3">
                <input id="cFName" placeholder="שם פרטי">
                <input id="cLName" placeholder="שם משפחה">
                <input id="cPlate" placeholder="מספר רכב" class="font-bold ltr text-center">
                <input id="cPhone" placeholder="טלפון" type="tel" class="ltr">
                <input id="cModel" placeholder="דגם רכב (למשל: Audi A4)">
                <button onclick="saveClient()" class="btn-primary mt-4">שמור לקוח במערכת</button>
                <button onclick="deleteClient()" id="deleteBtn" class="hidden w-full p-3 text-red-500 font-bold text-xs uppercase">מחק לקוח מהמערכת</button>
                <button onclick="closeModal('clientModal')" class="w-full p-2 text-slate-300 font-bold text-xs uppercase">ביטול</button>
            </div>
        </div>
    </div>

    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-black mb-4">יצירת הצעת מחיר</h2>
            <div class="space-y-4">
                <textarea id="qDetails" placeholder="פירוט העבודה..." class="w-full p-3 border rounded-xl h-24 text-sm font-bold"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-black mr-1 uppercase">סה"כ חלקים (₪)</label>
                        <input id="qParts" type="number" oninput="calcTotal()" placeholder="0.00" class="font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-black mr-1 uppercase">סה"כ עבודה (₪)</label>
                        <input id="qLabor" type="number" oninput="calcTotal()" placeholder="0.00" class="font-bold">
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl space-y-1">
                    <div class="flex justify-between text-xs font-bold"><span>לפני מע"מ:</span> <span id="subtotal">₪0.00</span></div>
                    <div class="flex justify-between text-xs font-bold text-blue-600"><span>מע"מ (18%):</span> <span id="vatAmount">₪0.00</span></div>
                    <div class="flex justify-between text-lg font-black text-[#001e50] border-t pt-2 mt-2"><span>סה"כ לתשלום:</span> <span id="grandTotal">₪0.00</span></div>
                </div>
                <button onclick="sendSmartQuote()" class="btn-primary">שלח הצעה לחתימת לקוח</button>
                <button onclick="closeModal('quoteModal')" class="w-full p-2 text-slate-300 font-bold text-xs uppercase">ביטול</button>
            </div>
        </div>
    </div>

    <div id="sigModal" class="modal">
        <div class="modal-content text-center">
            <h2 class="text-xl font-black mb-4 italic">אישור עבודה חתום</h2>
            <div id="sigDownloadArea" class="bg-white border p-6 rounded-2xl mb-6">
                <p id="sigDetails" class="text-xs font-bold text-right mb-4 whitespace-pre-line"></p>
                <img id="sigImg" class="w-full border-t pt-4">
            </div>
            <button onclick="window.print()" class="btn-primary mb-2"><i class="fas fa-download ml-2"></i> הורד / הדפס מסמך</button>
            <button onclick="closeModal('sigModal')" class="w-full p-2 text-slate-300 font-bold text-xs uppercase">סגור</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let activePlate = "";
        let clientsData = [];

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // טעינת לקוחות
        db.collection("customers").onSnapshot(snap => {
            const cont = document.getElementById('clientsContainer');
            cont.innerHTML = "";
            clientsData = [];
            snap.forEach(doc => {
                const data = doc.data();
                clientsData.push(data);
                const hasSigned = data.pendingQuote && data.pendingQuote.signed;
                
                cont.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center active:scale-95 transition" onclick="openClientActions('${data.plate}')">
                        <div>
                            <h3 class="font-black text-slate-800">${data.fName} ${data.lName}</h3>
                            <p class="text-[10px] font-bold text-slate-400 ltr">${data.plate} | ${data.model}</p>
                        </div>
                        <div class="flex gap-2">
                            ${hasSigned ? '<button onclick="viewSig(\''+data.plate+'\'); event.stopPropagation();" class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center"><i class="fas fa-file-signature"></i></button>' : ''}
                            <button onclick="openQuote('${data.plate}'); event.stopPropagation();" class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><i class="fas fa-calculator"></i></button>
                        </div>
                    </div>
                `;
            });
        });

        // ניהול לקוח
        function openAddClient() {
            activePlate = "";
            document.getElementById('modalTitle').innerText = "הוספת לקוח חדש";
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('cPlate').disabled = false;
            ['cFName','cLName','cPlate','cPhone','cModel'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('clientModal').classList.add('active');
        }

        function openClientActions(plate) {
            activePlate = plate;
            const user = clientsData.find(u => u.plate === plate);
            document.getElementById('modalTitle').innerText = "עריכת לקוח";
            document.getElementById('deleteBtn').classList.remove('hidden');
            document.getElementById('cFName').value = user.fName;
            document.getElementById('cLName').value = user.lName;
            document.getElementById('cPlate').value = user.plate;
            document.getElementById('cPlate').disabled = true;
            document.getElementById('cPhone').value = user.phone;
            document.getElementById('cModel').value = user.model;
            document.getElementById('clientModal').classList.add('active');
        }

        async function saveClient() {
            const plate = document.getElementById('cPlate').value;
            const data = {
                fName: document.getElementById('cFName').value,
                lName: document.getElementById('cLName').value,
                plate: plate,
                phone: document.getElementById('cPhone').value,
                model: document.getElementById('cModel').value
            };
            await db.collection("customers").doc(plate).set(data, {merge: true});
            closeModal('clientModal');
        }

        async function deleteClient() {
            if(confirm("למחוק את הלקוח לצמיתות? לא ניתן לבטל פעולה זו.")) {
                await db.collection("customers").doc(activePlate).delete();
                closeModal('clientModal');
            }
        }

        // מחשבון הצעת מחיר
        function openQuote(plate) {
            activePlate = plate;
            document.getElementById('quoteModal').classList.add('active');
        }

        function calcTotal() {
            const parts = parseFloat(document.getElementById('qParts').value) || 0;
            const labor = parseFloat(document.getElementById('qLabor').value) || 0;
            const subtotal = parts + labor;
            const vat = subtotal * 0.18;
            const total = subtotal + vat;

            document.getElementById('subtotal').innerText = `₪${subtotal.toFixed(2)}`;
            document.getElementById('vatAmount').innerText = `₪${vat.toFixed(2)}`;
            document.getElementById('grandTotal').innerText = `₪${total.toFixed(2)}`;
        }

        async function sendSmartQuote() {
            const details = document.getElementById('qDetails').value;
            const parts = document.getElementById('qParts').value;
            const labor = document.getElementById('qLabor').value;
            const total = document.getElementById('grandTotal').innerText;

            const fullText = `${details}\n\nחלקים: ₪${parts}\nעבודה: ₪${labor}\nמע"מ: 18%\nסה"כ סופי: ${total}`;

            await db.collection("customers").doc(activePlate).update({
                pendingQuote: {
                    details: fullText,
                    signed: false,
                    date: new Date().toLocaleDateString('he-IL')
                }
            });
            alert("הצעה מפורטת נשלחה!");
            closeModal('quoteModal');
        }

        // צפייה בחתימה
        function viewSig(plate) {
            const user = clientsData.find(u => u.plate === plate);
            document.getElementById('sigDetails').innerText = `לקוח: ${user.fName} ${user.lName}\nרכב: ${user.plate}\nתאריך: ${user.pendingQuote.date}\n---\n${user.pendingQuote.details}`;
            document.getElementById('sigImg').src = user.pendingQuote.sigData;
            document.getElementById('sigModal').classList.add('active');
        }

        function filterClients() {
            const term = document.getElementById('adminSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#clientsContainer > div');
            cards.forEach(card => card.style.display = card.innerText.toLowerCase().includes(term) ? 'flex' : 'none');
        }
    </script>
</body>
</html>
