<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מרכז שירות ברע״מ | VAG Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f0f2f5; }
        .sidebar { background: #001e50; transition: all 0.3s; }
        .nav-link { border-radius: 12px; transition: 0.2s; }
        .nav-link:hover { background: rgba(255,255,255,0.1); }
        .nav-link.active { background: #0056b3; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; }
        .badge-new { background: #ef4444; color: white; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .ltr { direction: ltr; display: inline-block; }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="loginScreen" class="fixed inset-0 bg-[#001e50] z-[1000] flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center">
            <h1 class="text-2xl font-black text-[#001e50] mb-2 italic">VAG SYSTEM ADMIN</h1>
            <p class="text-gray-400 text-sm mb-8 font-bold">מרכז שירות ברע״מ - באר שבע</p>
            <input id="adminPass" type="password" placeholder="הכנס סיסמה לניהול" class="w-full p-5 bg-gray-50 border-2 border-gray-100 rounded-2xl mb-4 text-center text-xl ltr">
            <button onclick="checkAdminAuth()" class="w-full bg-[#001e50] text-white p-5 rounded-2xl font-black hover:bg-blue-800 transition shadow-lg">כניסה למערכת</button>
        </div>
    </div>

    <div id="adminApp" class="hidden flex w-full">
        <aside class="sidebar w-72 text-white p-6 hidden lg:flex flex-col">
            <div class="mb-10 text-center">
                <h2 class="text-2xl font-black italic">BARAM VAG</h2>
                <div class="h-1 w-12 bg-blue-500 mx-auto mt-2"></div>
            </div>
            
            <nav class="space-y-2 flex-1">
                <a href="#" class="nav-link active flex items-center p-4 gap-3"><i class="fas fa-users w-6"></i> <span>ניהול לקוחות</span></a>
                <a href="#" class="nav-link flex items-center p-4 gap-3"><i class="fas fa-file-invoice-dollar w-6"></i> <span>הצעות מחיר</span></a>
                <a href="#" class="nav-link flex items-center p-4 gap-3"><i class="fas fa-calendar-alt w-6"></i> <span>יומן תורים</span></a>
                <a href="#" class="nav-link flex items-center p-4 gap-3"><i class="fas fa-bullhorn w-6"></i> <span>שליחת הודעות</span></a>
            </nav>

            <button onclick="logoutAdmin()" class="mt-auto p-4 text-red-400 font-bold hover:bg-red-500/10 rounded-xl"><i class="fas fa-sign-out-alt ml-2"></i> התנתק</button>
        </aside>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <h3 class="text-2xl font-black text-[#001e50]">מסך ניהול לקוחות מרכזי</h3>
                <div class="flex items-center gap-4">
                    <div class="bg-white p-3 px-5 rounded-2xl shadow-sm border">
                        <span class="text-xs font-bold text-gray-400">לקוחות רשומים:</span>
                        <span id="totalClients" class="mr-2 font-black text-blue-900">0</span>
                    </div>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="p-6 bg-gray-50 border-b flex justify-between items-center">
                    <input type="text" id="clientSearch" placeholder="חיפוש לפי שם, ת.ז או מספר רכב..." class="bg-white border p-3 px-5 rounded-xl text-sm w-72 outline-none focus:ring-2 ring-blue-900/20">
                </div>
                <table class="w-full text-right">
                    <thead>
                        <tr class="text-xs font-black text-gray-400 border-b uppercase">
                            <th class="p-6">פרטי לקוח / רכב</th>
                            <th class="p-6">סטטוסים</th>
                            <th class="p-6">התראות</th>
                            <th class="p-6 text-center">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="clientModal" class="hidden fixed inset-0 bg-black/60 z-[500] flex items-center justify-end p-0 md:p-4">
        <div class="bg-white w-full max-w-5xl h-full md:h-[95vh] md:rounded-[2.5rem] overflow-hidden flex flex-col animate-slide-in">
            <div class="p-8 bg-gray-50 border-b flex justify-between items-start">
                <div>
                    <h2 id="mClientName" class="text-3xl font-black text-[#001e50]"></h2>
                    <p id="mClientSub" class="text-gray-400 font-bold ltr"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openEditForm()" class="bg-blue-50 text-blue-600 p-3 px-5 rounded-xl font-black text-sm hover:bg-blue-100"><i class="fas fa-edit ml-1"></i> ערוך פרטים</button>
                    <button onclick="closeClientModal()" class="text-gray-300 text-3xl hover:text-red-500">&times;</button>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden">
                <div class="w-72 bg-gray-50/50 border-l p-6 overflow-y-auto space-y-6">
                    <div>
                        <h4 class="text-[10px] font-black text-gray-400 uppercase mb-3">פרטי התקשרות</h4>
                        <p class="text-sm font-bold" id="mPhone"></p>
                        <p class="text-sm text-gray-500" id="mAddr"></p>
                    </div>
                    <div>
                        <h4 class="text-[10px] font-black text-gray-400 uppercase mb-3">נתוני רכב</h4>
                        <div class="bg-white p-4 rounded-2xl border text-sm space-y-2">
                            <div class="flex justify-between"><span>ק"מ:</span> <b id="mKm" class="ltr"></b></div>
                            <div class="flex justify-between"><span>שנה:</span> <b id="mYear"></b></div>
                        </div>
                    </div>
                    <button onclick="sendQuickMessage()" class="w-full bg-[#001e50] text-white p-4 rounded-2xl text-xs font-black shadow-lg">שלח הודעה ללקוח</button>
                    <button onclick="downloadAllHistory()" class="w-full bg-white border-2 border-blue-900 text-[#001e50] p-4 rounded-2xl text-xs font-black">הורד כל המסמכים</button>
                </div>

                <div class="flex-1 p-8 overflow-y-auto">
                    <div class="flex gap-6 border-b mb-8">
                        <button onclick="showHistorySection('quotes')" class="h-tab active pb-4 text-sm font-black text-blue-900 border-b-2 border-blue-900">הצעות מחיר</button>
                        <button onclick="showHistorySection('services')" class="h-tab pb-4 text-sm font-black text-gray-400">טיפולים</button>
                        <button onclick="showHistorySection('tests')" class="h-tab pb-4 text-sm font-black text-gray-400">טסטים</button>
                        <button onclick="showHistorySection('checks')" class="h-tab pb-4 text-sm font-black text-gray-400">ביקורות</button>
                    </div>

                    <div id="historyList" class="space-y-4">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8">
            <h3 class="text-xl font-black mb-6">עריכת לקוח</h3>
            <div id="editForm" class="space-y-4">
                <input id="eFName" type="text" placeholder="שם פרטי" class="w-full p-4 bg-gray-50 rounded-xl border">
                <input id="eLName" type="text" placeholder="שם משפחה" class="w-full p-4 bg-gray-50 rounded-xl border">
                <input id="ePhone" type="text" placeholder="טלפון" class="w-full p-4 bg-gray-50 rounded-xl border ltr">
                <input id="eModel" type="text" placeholder="דגם רכב" class="w-full p-4 bg-gray-50 rounded-xl border">
                <button onclick="saveClientEdit()" class="w-full bg-green-600 text-white p-5 rounded-2xl font-black">שמור שינויים</button>
                <button onclick="closeEditModal()" class="w-full text-gray-400 font-bold">ביטול</button>
            </div>
        </div>
    </div>

    <script>
        // --- אבטחה וכניסה (24 שעות) ---
        const ADMIN_PASS = "baram!14567";

        function checkAdminAuth() {
            const input = document.getElementById('adminPass').value;
            if (input === ADMIN_PASS) {
                const expiry = new Date().getTime() + (24 * 60 * 60 * 1000);
                localStorage.setItem('admin_access', expiry);
                initAdmin();
            } else {
                alert("סיסמה שגויה!");
            }
        }

        function isAuth() {
            const expiry = localStorage.getItem('admin_access');
            if (!expiry) return false;
            return new Date().getTime() < parseInt(expiry);
        }

        if (isAuth()) { initAdmin(); }

        function logoutAdmin() {
            localStorage.removeItem('admin_access');
            location.reload();
        }

        // --- אתחול מערכת ---
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function initAdmin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminApp').classList.remove('hidden');
            loadClients();
        }

        // --- ניהול לקוחות ---
        function loadClients() {
            db.collection("customers").onSnapshot(snapshot => {
                const body = document.getElementById('clientsTableBody');
                body.innerHTML = "";
                document.getElementById('totalClients').innerText = snapshot.size;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasUnread = data.messages?.some(m => m.fromClient && !m.readByAdmin);
                    const pendingQuote = data.history?.quotes?.some(q => q.signed && !q.handled);

                    body.innerHTML += `
                        <tr class="border-b hover:bg-blue-50/30 transition group">
                            <td class="p-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-[#001e50] text-white rounded-2xl flex items-center justify-center font-black">${data.fName[0]}</div>
                                    <div>
                                        <p class="font-black text-gray-800">${data.fName} ${data.lName}</p>
                                        <p class="text-xs text-gray-400 font-bold ltr">${data.plate} | ${data.model}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-6">
                                ${data.lastSeen ? `<span class="status-badge bg-green-100 text-green-700">צפה בהצעה <i class="fas fa-check"></i></span>` : `<span class="status-badge bg-gray-100 text-gray-400">טרם צפה</span>`}
                            </td>
                            <td class="p-6">
                                ${hasUnread ? `<span class="badge-new status-badge">הודעה חדשה!</span>` : ''}
                                ${pendingQuote ? `<span class="bg-orange-500 text-white status-badge mr-2">חתימה חדשה!</span>` : ''}
                            </td>
                            <td class="p-6 text-center">
                                <button onclick="viewClient('${data.plate}')" class="bg-[#001e50] text-white p-3 px-6 rounded-xl text-xs font-black shadow-md hover:scale-105 transition">עיון בתיק</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        // --- עיון בפרטי לקוח (היסטוריה ללא הגבלה) ---
        async function viewClient(plate) {
            const doc = await db.collection("customers").doc(plate).get();
            const data = doc.data();
            window.activeClient = data;

            document.getElementById('clientModal').classList.remove('hidden');
            document.getElementById('mClientName').innerText = `${data.fName} ${data.lName}`;
            document.getElementById('mClientSub').innerText = `${data.model} • ${data.plate}`;
            document.getElementById('mPhone').innerText = data.phone;
            document.getElementById('mAddr').innerText = data.addr;
            document.getElementById('mKm').innerText = data.km.toLocaleString();
            document.getElementById('mYear').innerText = data.year;

            showHistorySection('quotes');
        }

        function showHistorySection(type) {
            const container = document.getElementById('historyList');
            container.innerHTML = "";
            const items = window.activeClient.history[type] || [];

            if(items.length === 0) {
                container.innerHTML = `<p class="text-gray-400 italic text-center py-10">אין היסטוריה בקטגוריה זו.</p>`;
                return;
            }

            items.forEach(item => {
                container.innerHTML += `
                    <div class="card p-5 border flex justify-between items-center group">
                        <div class="flex gap-4 items-center">
                            <div class="p-3 bg-gray-50 rounded-xl group-hover:bg-blue-50 transition">
                                <i class="fas ${type === 'quotes' ? 'fa-file-signature' : 'fa-tools'} text-blue-900"></i>
                            </div>
                            <div>
                                <p class="font-black text-sm">${item.title || item.desc}</p>
                                <p class="text-[10px] text-gray-400 font-bold ltr">${item.date}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            ${item.signed ? `<span class="text-green-600 font-black text-[10px] ml-4"><i class="fas fa-check-circle"></i> מאושר וחתוך</span>` : ''}
                            <button onclick="downloadSpecific('${item.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        // --- עריכת לקוח ---
        function openEditForm() {
            const d = window.activeClient;
            document.getElementById('eFName').value = d.fName;
            document.getElementById('eLName').value = d.lName;
            document.getElementById('ePhone').value = d.phone;
            document.getElementById('eModel').value = d.model;
            document.getElementById('editModal').classList.remove('hidden');
        }

        async function saveClientEdit() {
            const plate = window.activeClient.plate;
            const updates = {
                fName: document.getElementById('eFName').value,
                lName: document.getElementById('eLName').value,
                phone: document.getElementById('ePhone').value,
                model: document.getElementById('eModel').value
            };
            await db.collection("customers").doc(plate).update(updates);
            alert("הפרטים עודכנו בהצלחה!");
            closeEditModal();
            viewClient(plate);
        }

        function closeClientModal() { document.getElementById('clientModal').classList.add('hidden'); }
        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

        // --- פונקציות עזר נוספות ---
        function downloadAllHistory() {
            alert("מכין את כל קבצי ההיסטוריה של הלקוח להורדה מרוכזת...");
        }

    </script>
</body>
</html>
