<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול מרכז שירות ברע״מ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f0f2f5; }
        .sidebar { background: #001e50; transition: all 0.3s; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .hidden { display: none !important; }
        .ltr { direction: ltr; display: inline-block; }
    </style>
</head>
<body class="flex min-h-screen">

    <div id="loginOverlay" class="fixed inset-0 bg-[#001e50] z-[1000] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6 text-blue-900">כניסת מנהל</h2>
            <input id="adminPass" type="password" placeholder="הכנס סיסמה" class="w-full p-4 border rounded-2xl mb-4 text-center ltr">
            <button onclick="checkAdminAuth()" class="w-full bg-blue-900 text-white p-4 rounded-2xl font-bold hover:bg-blue-800 transition">כניסה</button>
        </div>
    </div>

    <div id="mainContent" class="hidden flex w-full">
        <aside class="sidebar w-64 text-white p-6 hidden md:block">
            <h1 class="text-2xl font-black italic mb-10">ברע״מ ADMIN</h1>
            <nav class="space-y-4">
                <a href="#" class="block p-3 rounded-xl bg-white/10 hover:bg-white/20"><i class="fas fa-users ml-2"></i> לקוחות</a>
                <a href="#" class="block p-3 rounded-xl hover:bg-white/20"><i class="fas fa-file-invoice-dollar ml-2"></i> הצעות מחיר</a>
                <a href="#" class="block p-3 rounded-xl hover:bg-white/20"><i class="fas fa-calendar-check ml-2"></i> תורים</a>
                <button onclick="logoutAdmin()" class="block w-full text-right p-3 rounded-xl text-red-400 hover:bg-red-500/10"><i class="fas fa-sign-out-alt ml-2"></i> יציאה</button>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-gray-800">ניהול לקוחות פעילים</h2>
                <div class="bg-white px-4 py-2 rounded-xl shadow-sm">
                    <span id="notificationCount" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2">0</span>
                    <span class="text-sm font-bold">התראות חדשות</span>
                </div>
            </div>

            <div class="card p-6 overflow-x-auto">
                <table class="w-full text-right">
                    <thead>
                        <tr class="text-gray-400 border-b">
                            <th class="pb-4">לקוח / רכב</th>
                            <th class="pb-4">סטטוס צפייה</th>
                            <th class="pb-4 text-center">פעולות אחרונות</th>
                            <th class="pb-4">הצעות מחיר</th>
                            <th class="pb-4">ניהול</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="customerModal" class="hidden fixed inset-0 bg-black/60 z-[500] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-3xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 id="modalClientName" class="text-2xl font-black text-blue-900"></h3>
                    <p id="modalClientPlate" class="text-gray-400 font-bold ltr"></p>
                </div>
                <button onclick="closeCustomerModal()" class="text-gray-400 text-2xl">&times;</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <button onclick="showActionForm('quote')" class="bg-blue-600 text-white p-4 rounded-2xl text-xs font-bold hover:bg-blue-700">+ הצעת מחיר חדשה</button>
                <button onclick="showActionForm('message')" class="bg-emerald-600 text-white p-4 rounded-2xl text-xs font-bold hover:bg-emerald-700">שלח הודעה ללקוח</button>
                <button onclick="showActionForm('service')" class="bg-gray-800 text-white p-4 rounded-2xl text-xs font-bold">תיעוד טיפול/טסט</button>
                <button onclick="downloadAllQuotes()" class="bg-orange-500 text-white p-4 rounded-2xl text-xs font-bold">הורד כל ההצעות (ZIP)</button>
            </div>

            <div class="border-b mb-6">
                <ul class="flex gap-6 text-sm font-bold text-gray-500">
                    <li class="border-b-2 border-blue-900 text-blue-900 pb-2 cursor-pointer">היסטוריה מלאה (ללא הגבלת זמן)</li>
                </ul>
            </div>

            <div id="historyTimeline" class="space-y-4">
                </div>
        </div>
    </div>

    <script>
        // --- 1. AUTH LOGIC (24 HOURS) ---
        const ADMIN_PASS = "baram!14567";
        
        function checkAdminAuth() {
            const input = document.getElementById('adminPass').value;
            if(input === ADMIN_PASS) {
                const expiry = new Date().getTime() + (24 * 60 * 60 * 1000);
                localStorage.setItem('adminAuthExpiry', expiry);
                initAdmin();
            } else {
                alert("סיסמה שגויה!");
            }
        }

        function isAuthValid() {
            const expiry = localStorage.getItem('adminAuthExpiry');
            if(!expiry) return false;
            return new Date().getTime() < parseInt(expiry);
        }

        if(isAuthValid()) {
            initAdmin();
        }

        function logoutAdmin() {
            localStorage.removeItem('adminAuthExpiry');
            location.reload();
        }

        // --- 2. FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 3. SYSTEM LOGIC ---
        function initAdmin() {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            loadClients();
        }

        async function loadClients() {
            db.collection("customers").onSnapshot(snapshot => {
                const body = document.getElementById('clientTableBody');
                body.innerHTML = "";
                let notifications = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasUnread = data.messages?.some(m => m.fromClient && !m.readByAdmin);
                    const pendingSignature = data.quotes?.some(q => q.signed && !q.processedByAdmin);

                    if(hasUnread || pendingSignature) notifications++;

                    body.innerHTML += `
                        <tr class="border-b hover:bg-gray-50 transition">
                            <td class="py-4">
                                <p class="font-bold text-blue-900">${data.fName} ${data.lName}</p>
                                <p class="text-xs text-gray-400 ltr font-bold">${data.plate} | ${data.model}</p>
                            </td>
                            <td class="py-4">
                                ${data.lastQuoteSeen ? 
                                    '<span class="text-green-500 text-xs font-bold"><i class="fas fa-check-double"></i> צפה בהצעה</span>' : 
                                    '<span class="text-gray-300 text-xs font-bold">טרם צפה</span>'}
                            </td>
                            <td class="py-4 text-center">
                                ${pendingSignature ? '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-bold animate-bounce">נחתמה הצעה!</span>' : '<span class="text-gray-400 text-xs">אין חדש</span>'}
                            </td>
                            <td class="py-4 font-bold text-sm ltr">
                                ₪${calculateTotalQuotes(data.quotes)}
                            </td>
                            <td class="py-4">
                                <button onclick="viewCustomer('${data.plate}')" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-black">ניהול היסטוריה</button>
                            </td>
                        </tr>
                    `;
                });
                document.getElementById('notificationCount').innerText = notifications;
            });
        }

        async function viewCustomer(plate) {
            const doc = await db.collection("customers").doc(plate).get();
            const data = doc.data();
            window.currentCustomerPlate = plate;

            document.getElementById('customerModal').classList.remove('hidden');
            document.getElementById('modalClientName').innerText = `${data.fName} ${data.lName}`;
            document.getElementById('modalClientPlate').innerText = plate;

            renderHistory(data);
        }

        function renderHistory(data) {
            const container = document.getElementById('historyTimeline');
            container.innerHTML = "";
            
            // איחוד כל האירועים (הצעות, טיפולים, הודעות) לציר זמן אחד
            const events = [
                ...(data.quotes || []).map(q => ({...q, type: 'quote'})),
                ...(data.services || []).map(s => ({...s, type: 'service'})),
                ...(data.messages || []).map(m => ({...m, type: 'message'}))
            ].sort((a,b) => new Date(b.date) - new Date(a.date));

            events.forEach(ev => {
                let icon = "fa-info-circle";
                let color = "gray";
                let content = "";

                if(ev.type === 'quote') {
                    icon = "fa-file-signature";
                    color = ev.signed ? "emerald" : "orange";
                    content = `הצעת מחיר: ${ev.title} | ₪${ev.total} ${ev.signed ? '<b>(חתומה)</b>' : '(ממתין)'}`;
                } else if(ev.type === 'service') {
                    icon = "fa-tools";
                    color = "blue";
                    content = `טיפול/טסט: ${ev.desc} | ק"מ: ${ev.km}`;
                }

                container.innerHTML += `
                    <div class="flex items-start gap-4 p-4 rounded-2xl bg-${color}-50 border border-${color}-100">
                        <div class="bg-${color}-500 text-white p-3 rounded-xl shadow-sm">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs font-bold text-gray-500">${new Date(ev.date).toLocaleString('he-IL')}</p>
                            <p class="text-sm font-bold text-gray-800">${content}</p>
                            ${ev.signature ? `<img src="${ev.signature}" class="h-12 border mt-2 bg-white rounded">` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function calculateTotalQuotes(quotes) {
            if(!quotes) return 0;
            return quotes.reduce((acc, curr) => acc + parseInt(curr.total || 0), 0);
        }

        function closeCustomerModal() {
            document.getElementById('customerModal').classList.add('hidden');
        }

        // --- פונקציות להורדה ושליחה (דוגמה) ---
        async function downloadAllQuotes() {
            alert("מכין קובץ להורדה עם כל הצעות המחיר של הלקוח...");
            // כאן אפשר לשלב ספריה כמו JSZip
        }

    </script>
</body>
</html>
