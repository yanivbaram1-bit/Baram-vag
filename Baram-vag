<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול CRM - מרכז שירות ברע״מ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700;800&display=swap');
        body { font-family: 'Assistant', sans-serif; background: #f8fafc; }
        .sidebar { background: #0f172a; color: white; height: 100vh; position: fixed; width: 240px; }
        .main-content { margin-right: 240px; padding: 30px; }
        .status-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        tr:nth-child(even) { background-color: #f1f5f9; }
        .modal { background: rgba(0,0,0,0.5); display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
    </style>
</head>
<body>

    <div class="sidebar p-6">
        <h1 class="text-2xl font-black mb-10 text-blue-400">ניהול ברע״מ</h1>
        <nav class="space-y-4">
            <a href="#" onclick="showSection('dashboard')" class="block py-2 px-4 hover:bg-blue-600 rounded-lg transition"><i class="fas fa-chart-line ml-2"></i> דשבורד</a>
            <a href="#" onclick="showSection('customers')" class="block py-2 px-4 hover:bg-blue-600 rounded-lg transition"><i class="fas fa-users ml-2"></i> ניהול לקוחות</a>
            <a href="#" onclick="showSection('calendar')" class="block py-2 px-4 hover:bg-blue-600 rounded-lg transition"><i class="fas fa-calendar-alt ml-2"></i> לו״ז עבודה</a>
        </nav>
    </div>

    <div class="main-content">
        
        <div id="dashboardSection">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-slate-800">לוח בקרה</h2>
                <div class="text-slate-500 font-bold" id="adminDate"></div>
            </div>
            
            <div class="grid grid-cols-3 gap-6 mb-10">
                <div class="status-card border-r-4 border-blue-500">
                    <p class="text-slate-500 text-sm font-bold">סה״כ לקוחות</p>
                    <h3 class="text-4xl font-black" id="totalCustomers">0</h3>
                </div>
                <div class="status-card border-r-4 border-green-500">
                    <p class="text-slate-500 text-sm font-bold">טיפולים היום</p>
                    <h3 class="text-4xl font-black" id="todayJobs">0</h3>
                </div>
                <div class="status-card border-r-4 border-yellow-500">
                    <p class="text-slate-500 text-sm font-bold">ממתינים לאבחון</p>
                    <h3 class="text-4xl font-black">3</h3>
                </div>
            </div>
        </div>

        <div id="customersSection" class="hidden">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">מאגר לקוחות</h2>
            <div class="mb-4 flex gap-4">
                <input type="text" id="searchCustomer" onkeyup="filterCustomers()" placeholder="חפש לפי מספר רכב או שם..." class="p-3 border rounded-xl w-1/3">
            </div>
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <table class="w-full text-right">
                    <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                        <tr>
                            <th class="p-4">מספר רכב</th>
                            <th class="p-4">שם לקוח</th>
                            <th class="p-4">דגם</th>
                            <th class="p-4">טיפול אחרון</th>
                            <th class="p-4">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="calendarSection" class="hidden">
            <h2 class="text-3xl font-bold text-slate-800 mb-6">לו״ז עבודה עתידי</h2>
            <div id="calendarList" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="editModal" class="modal flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-lg w-full">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">עדכון כרטיס רכב</h3>
            <div class="space-y-3">
                <input type="hidden" id="editPlate">
                <label class="block text-xs font-bold text-slate-400">תאריך טיפול הבא</label>
                <input type="date" id="editNextDate" class="w-full p-2 border rounded">
                <label class="block text-xs font-bold text-slate-400">פירוט עבודה (מה בוצע/יבוצע)</label>
                <textarea id="editWork" class="w-full p-2 border rounded h-32"></textarea>
                <div class="flex gap-2 mt-4">
                    <button onclick="saveCustomerEdit()" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold">שמור שינויים</button>
                    <button onclick="closeModal()" class="flex-1 bg-slate-200 py-2 rounded-xl font-bold">ביטול</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // אותו קונפיגורציה כמו באתר
        const firebaseConfig = {
            apiKey: "AIzaSyDD7YAdTePRWYjwBbmy3gLRYd_OLDwpTL8",
            authDomain: "baram-vag-45e12.firebaseapp.com",
            projectId: "baram-vag-45e12",
            storageBucket: "baram-vag-45e12.firebasestorage.app",
            messagingSenderId: "761383355945",
            appId: "1:761383355945:web:552554b5a6b9fe5e78be38"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.getElementById('adminDate').innerText = new Date().toLocaleDateString('he-IL');

        function showSection(section) {
            ['dashboard', 'customers', 'calendar'].forEach(s => {
                document.getElementById(s + 'Section').classList.add('hidden');
            });
            document.getElementById(section + 'Section').classList.remove('hidden');
            if(section === 'customers') loadCustomers();
            if(section === 'calendar') loadCalendar();
        }

        async function loadCustomers() {
            const snapshot = await db.collection("customers").get();
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            document.getElementById('totalCustomers').innerText = snapshot.size;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-4 font-mono font-bold">${data.plate}</td>
                        <td class="p-4">${data.firstName} ${data.lastName}</td>
                        <td class="p-4">${data.carModel} (${data.year})</td>
                        <td class="p-4 text-sm text-slate-500">${data.lastServiceDate}</td>
                        <td class="p-4">
                            <button onclick="openEditModal('${data.plate}')" class="text-blue-600 hover:text-blue-900"><i class="fas fa-edit"></i> עדכן</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openEditModal(plate) {
            db.collection("customers").doc(plate).get().then(doc => {
                const data = doc.data();
                document.getElementById('editPlate').value = plate;
                document.getElementById('modalTitle').innerText = "עדכון רכב: " + plate;
                document.getElementById('editNextDate').value = data.nextServiceDate;
                document.getElementById('editWork').value = data.lastServiceWork;
                document.getElementById('editModal').style.display = 'flex';
            });
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveCustomerEdit() {
            const plate = document.getElementById('editPlate').value;
            await db.collection("customers").doc(plate).update({
                nextServiceDate: document.getElementById('editNextDate').value,
                lastServiceWork: document.getElementById('editWork').value,
                lastServiceDate: new Date().toLocaleDateString('he-IL')
            });
            alert("הנתונים עודכנו! הלקוח יראה זאת באפליקציה.");
            closeModal();
            loadCustomers();
        }

        async function loadCalendar() {
            const snapshot = await db.collection("customers").get();
            const list = document.getElementById('calendarList');
            list.innerHTML = '';
            
            let jobs = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.nextServiceDate && data.nextServiceDate !== "בתיאום") {
                    jobs.push(data);
                }
            });

            // מיון לפי תאריך
            jobs.sort((a,b) => new Date(a.nextServiceDate) - new Date(b.nextServiceDate));

            jobs.forEach(job => {
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-r-4 border-blue-600 flex justify-between items-center">
                        <div>
                            <span class="text-xs font-bold text-blue-600 uppercase">${job.nextServiceDate}</span>
                            <h4 class="text-lg font-bold">${job.firstName} ${job.lastName} - ${job.carModel}</h4>
                            <p class="text-sm text-slate-500">${job.lastServiceWork}</p>
                        </div>
                        <div class="text-left font-mono font-bold text-xl">${job.plate}</div>
                    </div>
                `;
            });
        }

        function filterCustomers() {
            let input = document.getElementById('searchCustomer').value.toLowerCase();
            let rows = document.getElementById('customersTableBody').getElementsByTagName('tr');
            for (let row of rows) {
                row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
            }
        }

        // טעינה ראשונית
        loadCustomers();
    </script>
</body>
</html>

